<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Ninjago Battlegrounds</title>
<style>
  body, html {
    margin: 0;
    padding: 0;
    background: black;
    overflow: hidden;
    font-family: Arial, sans-serif;
  }
  #gameCanvas {
    display: block;
    width: 100vw;
    height: 100vh;
    outline: none;
  }
  #menu {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
            background: url("images/fondojuego.png.png") no-repeat center center;
    background-size: cover;
    z-index: 1000;
  }
  #menu button {
    margin: 10px;
    padding: 15px 30px;
    font-size: 20px;
    font-weight: bold;
    cursor: pointer;
    border: none;
    border-radius: 12px;
    background: #f00;
    color: #fff;
    transition: all 0.3s ease;
  }
  #menu button:hover {
    background: #d00;
    transform: scale(1.05);
  }

  #shop, #worldSelect, #characterSelect, #onlineMode {
    position: fixed !important;
    top: 0 !important; 
    left: 0 !important; 
    right: 0 !important; 
    bottom: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
    color: white;
    z-index: 1000;
    overflow-y: auto;
  }

  #shop h1, #worldSelect h1, #characterSelect h1, #onlineMode h1 {
    color: white;
    font-size: 40px;
    margin-bottom: 20px;
  }

  /* Asegurar que los elementos se muestren cuando tienen display: flex */
  #shop[style*="display: flex"], 
  #worldSelect[style*="display: flex"], 
  #characterSelect[style*="display: flex"], 
  #onlineMode[style*="display: flex"] {
    display: flex !important;
    visibility: visible !important;
    opacity: 1 !important;
  }
  .characterGrid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 30px;
    margin: 20px;
  }
  .characterCard {
    background: rgba(255,255,255,0.1);
    border: 2px solid #333;
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
  }
  .characterCard:hover {
    border-color: #f00;
    transform: scale(1.05);
  }
  .characterCard img {
    width: 120px;
    height: 120px;
    object-fit: cover;
    border-radius: 5px;
  }
  .characterCard h3 {
    color: white;
    margin: 15px 0 10px 0;
  }
  .characterCard p {
    color: #ccc;
    margin: 10px 0;
    font-size: 14px;
  }
  .stats {
    display: flex;
    justify-content: space-around;
    margin-top: 15px;
  }
  .stat {
    text-align: center;
  }
  .stat-value {
    color: #f00;
    font-weight: bold;
  }
  .locked-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 10px;
    font-weight: bold;
    font-size: 18px;
    color: #ff6b6b;
  }
  .worldSelect {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.9);
    z-index: 1500;
  }
  
  /* Estilos para la tienda */
  .shop {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.9);
    z-index: 2000;
    overflow-y: auto;
    padding: 20px;
  }
  
  .shopSection {
    background: rgba(255,255,255,0.1);
    border: 2px solid #333;
    border-radius: 15px;
    padding: 25px;
    margin: 20px 0;
    width: 80%;
    max-width: 800px;
  }
  
  .shopSection h2 {
    text-align: center;
    margin-bottom: 20px;
  }
  
  .cashPackages {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 20px;
  }
  
  .cashPackage {
    background: rgba(255,255,255,0.1);
    border: 2px solid #666;
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .cashPackage:hover {
    border-color: #00ff00;
    transform: scale(1.05);
    background: rgba(0,255,0,0.1);
  }
  
  .cashPackage h3 {
    color: #00ff00;
    margin: 10px 0;
  }
  
  .cashPackage p {
    color: #ccc;
    margin: 10px 0;
  }
  
  .characterShop {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-top: 20px;
  }
  
  .shopCharacter {
    background: rgba(255,255,255,0.1);
    border: 2px solid #666;
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .shopCharacter:hover {
    border-color: #0080ff;
    transform: scale(1.05);
    background: rgba(0,128,255,0.1);
  }
  
  .shopCharacter img {
    width: 100px;
    height: 100px;
    object-fit: cover;
    border-radius: 10px;
    margin-bottom: 15px;
    transition: all 0.3s ease;
  }
  
  .shopCharacter h3 {
    color: #0080ff;
    margin: 10px 0;
  }
  
  .shopCharacter p {
    color: #ccc;
    margin: 10px 0;
  }
  
  .shopCharacter .stats {
    display: flex;
    justify-content: space-around;
    margin: 15px 0;
  }
  
  .shopCharacter .stat {
    color: #ccc;
    font-size: 12px;
  }
  
  .buyButton {
    background: #00ff00;
    color: #000;
    border: none;
    border-radius: 8px;
    padding: 10px 20px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .buyButton:hover {
    background: #00cc00;
    transform: scale(1.05);
  }
  
  .buyButton:disabled {
    background: #666;
    cursor: not-allowed;
    transform: none;
  }
  
  /* Estilos para cajas de habilidades */
  .skillBoxes {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 20px;
  }
  
  .skillBox {
    background: rgba(255,255,255,0.1);
    border: 2px solid #666;
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .skillBox:hover {
    border-color: #ffd700;
    transform: scale(1.05);
    background: rgba(255,215,0,0.1);
  }
  
  .skillBox h3 {
    color: #ffd700;
    margin: 10px 0;
  }
  
  .skillBox p {
    color: #ccc;
    margin: 8px 0;
    font-size: 14px;
  }
  
  /* Estilos para habilidades disponibles */
  .availableSkills {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-top: 20px;
  }
  
  .skillItem {
    background: rgba(255,255,255,0.1);
    border: 2px solid #666;
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    transition: all 0.3s ease;
  }
  
  .skillItem:hover {
    border-color: #ff6b6b;
    background: rgba(255,107,107,0.1);
  }
  
  .skillItem h4 {
    color: #ff6b6b;
    margin: 10px 0;
  }
  
  .skillItem p {
    color: #ccc;
    margin: 8px 0;
    font-size: 14px;
  }
  
  /* Estilos para habilidades activas */
  .activeSkills {
    background: rgba(0,255,0,0.1);
    border: 2px solid #00ff00;
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    min-height: 100px;
  }
  
  .activeSkills h4 {
    color: #00ff00;
    margin-bottom: 15px;
  }
  
  .activeSkills div {
    background: rgba(0,255,0,0.2);
    border: 1px solid #00ff00;
    border-radius: 5px;
    padding: 8px;
    margin: 5px 0;
    display: inline-block;
    min-width: 150px;
  }
  
  /* Estilos para el modo aventura */
  .adventureMode {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
    z-index: 2500;
    overflow-y: auto;
    padding: 20px;
  }
  
  .cityMap {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 30px;
    margin: 20px 0;
    width: 90%;
    max-width: 1200px;
  }
  
  .cityDistrict {
    background: rgba(255,255,255,0.1);
    border: 2px solid rgba(255,255,255,0.3);
    border-radius: 15px;
    padding: 25px;
    text-align: center;
  }
  
  .cityDistrict h3 {
    margin-bottom: 20px;
    font-size: 24px;
  }
  
  .building {
    background: rgba(255,255,255,0.1);
    border: 2px solid rgba(255,255,255,0.2);
    border-radius: 10px;
    padding: 20px;
    margin: 15px 0;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .building:hover {
    border-color: #FFD700;
    background: rgba(255,215,0,0.1);
    transform: scale(1.05);
  }
  
  .buildingIcon {
    font-size: 48px;
    margin-bottom: 15px;
  }
  
  .building h4 {
    color: #FFD700;
    margin: 10px 0;
    font-size: 18px;
  }
  
  .building p {
    color: #ccc;
    margin: 10px 0;
    font-size: 14px;
  }
  
  .tournamentInfo {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 15px;
  }
  
  .difficulty {
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
  }
  
  .difficulty.easy {
    background: #4CAF50;
    color: white;
  }
  
  .difficulty.medium {
    background: #FF9800;
    color: white;
  }
  
  .difficulty.hard {
    background: #F44336;
    color: white;
  }
  
  .reward {
    color: #FFD700;
    font-weight: bold;
    font-size: 14px;
  }
  
  /* Estilos para la interfaz del torneo */
  .tournamentUI {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.9);
    border: 3px solid #FFD700;
    border-radius: 15px;
    padding: 30px;
    text-align: center;
    z-index: 3000;
    min-width: 400px;
    color: white;
  }
  
  .tournamentUI h2 {
    color: #FFD700;
    margin-bottom: 20px;
    font-size: 24px;
  }
  
  .tournamentProgress {
    margin: 20px 0;
  }
  
  .progressBar {
    width: 100%;
    height: 20px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 10px;
    overflow: hidden;
  }
  
  .progressFill {
    height: 100%;
    background: linear-gradient(90deg, #4CAF50, #FFD700);
    transition: width 0.3s ease;
  }
  
  .opponentInfo {
    margin: 20px 0;
  }
  
  .opponentCard {
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 10px;
    padding: 20px;
    margin: 15px 0;
  }
  
  .opponentCard h4 {
    color: #FFD700;
    margin-bottom: 15px;
  }
  
  .opponentCard p {
    color: #ccc;
    margin: 8px 0;
  }
  
  .startBattleBtn {
    background: #4CAF50;
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 25px;
    font-size: 18px;
    cursor: pointer;
    margin: 10px;
    transition: all 0.3s ease;
  }
  
  .startBattleBtn:hover {
    background: #45a049;
    transform: scale(1.05);
  }
  
  .exitBtn {
    background: #f44336;
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 25px;
    font-size: 18px;
    cursor: pointer;
    margin: 10px;
    transition: all 0.3s ease;
  }
  
  .exitBtn:hover {
    background: #da190b;
    transform: scale(1.05);
  }
  .worldGrid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 30px;
    margin: 30px;
  }
  .worldCard {
    background: rgba(255,255,255,0.1);
    border: 3px solid #333;
    border-radius: 15px;
    padding: 25px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 300px;
    height: 200px;
  }
  .worldCard:hover {
    border-color: #f00;
    transform: scale(1.05);
  }
  .worldCard img {
    width: 100%;
    height: 120px;
    object-fit: cover;
    border-radius: 10px;
    margin-bottom: 15px;
  }
  .worldCard h3 {
    color: white;
    margin: 10px 0;
    font-size: 20px;
  }
  .worldCard p {
    color: #ccc;
    font-size: 14px;
  }
  .gameUI {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 15px;
    border-radius: 10px;
    border: 2px solid #f00;
    z-index: 500;
  }
  .healthBar {
    width: 200px;
    height: 20px;
    background: #333;
    border-radius: 10px;
    overflow: hidden;
    margin: 5px 0;
  }
  .healthFill {
    height: 100%;
    background: linear-gradient(90deg, #f00, #ff0, #0f0);
    transition: width 0.3s ease;
  }
  .controls {
    position: absolute;
    bottom: 20px;
    left: 10px;
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 15px;
    border-radius: 10px;
    border: 2px solid #f00;
    z-index: 500;
  }
  .controls h4 {
    margin: 0 0 10px 0;
    color: #f00;
  }
  .control-row {
    display: flex;
    align-items: center;
    margin: 5px 0;
  }
  .key {
    background: #333;
    border: 1px solid #666;
    border-radius: 3px;
    padding: 2px 6px;
    margin: 0 5px;
    font-family: monospace;
    font-size: 12px;
  }
  .worldInfo {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 15px;
    border-radius: 10px;
    border: 2px solid #f00;
    z-index: 500;
    text-align: center;
  }

  /* Mobile Controls */
  #mobileControls {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 120px;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    z-index: 1000;
    touch-action: none;
  }

  .controlRow {
    display: flex;
    justify-content: space-between;
    align-items: center;
    height: 60px;
    padding: 0 20px;
  }

  .dpad {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    grid-template-rows: 1fr 1fr 1fr;
    gap: 2px;
    width: 120px;
    height: 120px;
  }

  .dpad button {
    background: rgba(255, 255, 255, 0.3);
    border: 2px solid rgba(255, 255, 255, 0.5);
    border-radius: 8px;
    color: white;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    user-select: none;
    -webkit-user-select: none;
    -webkit-touch-callout: none;
    touch-action: manipulation;
  }

  .dpad button:active {
    background: rgba(255, 255, 255, 0.6);
    transform: scale(0.95);
  }

  .actionButtons {
    display: flex;
    gap: 15px;
  }

  .actionBtn {
    width: 60px;
    height: 60px;
    background: rgba(255, 0, 0, 0.7);
    border: 2px solid rgba(255, 255, 255, 0.5);
    border-radius: 50%;
    color: white;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    user-select: none;
    -webkit-user-select: none;
    -webkit-touch-callout: none;
    touch-action: manipulation;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .actionBtn:active {
    background: rgba(255, 0, 0, 0.9);
    transform: scale(0.95);
  }

  /* Mobile Responsive Styles */
  @media (max-width: 768px) {
    #menu button {
      padding: 20px 40px;
      font-size: 24px;
      margin: 15px;
    }

    .characterGrid {
      grid-template-columns: 1fr;
      gap: 20px;
      margin: 10px;
    }

    .characterCard {
      padding: 15px;
    }

    .characterCard img {
      width: 100px;
      height: 100px;
    }

    .worldCard {
      margin: 10px;
      padding: 15px;
    }

    .worldCard img {
      width: 200px;
      height: 120px;
    }

    #mobileControls {
      display: block;
    }

    /* Adjust game canvas for mobile controls */
    #gameCanvas {
      height: calc(100vh - 120px);
    }

    /* Make buttons more touch-friendly */
    button {
      min-height: 44px;
      min-width: 44px;
    }

    /* Optimize shop for mobile */
    .shopContainer {
      padding: 10px;
    }

    .cashPackage, .shopCharacter, .skillBox, .skillItem {
      margin: 10px 0;
      padding: 15px;
    }

    /* Adventure mode mobile optimization */
    .adventureContainer {
      padding: 10px;
    }

    .building {
      margin: 10px 0;
      padding: 15px;
    }

    /* Online mode mobile optimization */
    .onlineContainer {
      padding: 10px;
    }

    #chatContainer {
      height: 200px;
    }

    #chatMessages {
      height: 150px;
    }

    /* Game UI mobile optimization */
    .gameUI {
      font-size: 14px;
      padding: 8px;
    }

    .gameUI h3 {
      font-size: 16px;
      margin: 5px 0;
    }

    .healthBar {
      height: 12px;
      margin: 5px 0;
    }

    .controls {
      font-size: 12px;
      padding: 8px;
    }

    .controls .key {
      padding: 2px 6px;
      font-size: 10px;
    }
  }

  @media (max-width: 480px) {
    #menu button {
      padding: 15px 30px;
      font-size: 20px;
      margin: 10px;
    }

    .characterCard img {
      width: 80px;
      height: 80px;
    }

    .worldCard img {
      width: 150px;
      height: 90px;
    }

    .dpad {
      width: 100px;
      height: 100px;
    }

    .actionBtn {
      width: 50px;
      height: 50px;
      font-size: 14px;
    }

    /* Additional mobile UI optimizations for small screens */
    .gameUI {
      font-size: 12px;
      padding: 6px;
    }

    .gameUI h3 {
      font-size: 14px;
    }

    .healthBar {
      height: 10px;
    }

    .controls {
      font-size: 10px;
      padding: 6px;
    }

    .controls .key {
      padding: 1px 4px;
      font-size: 9px;
    }
  }

  /* Payment System Styles */
  .offersSection {
    background: linear-gradient(135deg, #ff6b6b, #ffa500);
    border: 3px solid #ffd700;
    border-radius: 15px;
    padding: 20px;
    margin: 20px 0;
    text-align: center;
    box-shadow: 0 8px 32px rgba(255, 215, 0, 0.3);
  }

  .offersSection h2 {
    color: #fff;
    font-size: 28px;
    margin-bottom: 15px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
  }

  .offersGrid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin: 20px 0;
  }

  .offerCard {
    background: rgba(255, 255, 255, 0.95);
    border: 2px solid #ffd700;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .offerCard:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 24px rgba(0,0,0,0.2);
    border-color: #ff6b6b;
  }

  .offerCard::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255, 215, 0, 0.1), transparent);
    transform: rotate(45deg);
    transition: all 0.5s ease;
    opacity: 0;
  }

  .offerCard:hover::before {
    opacity: 1;
    animation: shimmer 1.5s infinite;
  }

  @keyframes shimmer {
    0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
    100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
  }

  .offerBadge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #ff4444;
    color: white;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 12px;
    font-weight: bold;
    transform: rotate(15deg);
  }

  .offerTitle {
    font-size: 20px;
    font-weight: bold;
    color: #333;
    margin-bottom: 10px;
  }

  .offerDescription {
    color: #666;
    margin-bottom: 15px;
    font-size: 14px;
  }

  .offerPrice {
    font-size: 24px;
    font-weight: bold;
    color: #ff6b6b;
    margin-bottom: 10px;
  }

  .offerValue {
    color: #28a745;
    font-weight: bold;
    margin-bottom: 15px;
  }

  .buyButton {
    background: linear-gradient(45deg, #ff6b6b, #ffa500);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 25px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
  }

  .buyButton:hover {
    background: linear-gradient(45deg, #ff5252, #ff9800);
    transform: scale(1.05);
  }

  /* Payment Modal */
  .paymentModal {
    display: none;
    position: fixed;
    z-index: 10000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.8);
    backdrop-filter: blur(5px);
  }

  .paymentModalContent {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    margin: 5% auto;
    padding: 30px;
    border: 3px solid #ffd700;
    border-radius: 20px;
    width: 90%;
    max-width: 500px;
    position: relative;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  }

  .closePayment {
    color: #fff;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    position: absolute;
    top: 15px;
    right: 20px;
  }

  .closePayment:hover {
    color: #ffd700;
  }

  .paymentForm {
    color: white;
  }

  .paymentForm h2 {
    text-align: center;
    margin-bottom: 30px;
    color: #ffd700;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
  }

  .formGroup {
    margin-bottom: 20px;
  }

  .formGroup label {
    display: block;
    margin-bottom: 8px;
    font-weight: bold;
    color: #fff;
  }

  .formGroup input, .formGroup select {
    width: 100%;
    padding: 12px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    font-size: 16px;
    box-sizing: border-box;
  }

  .formGroup input::placeholder {
    color: rgba(255, 255, 255, 0.7);
  }

  .formGroup input:focus, .formGroup select:focus {
    outline: none;
    border-color: #ffd700;
    background: rgba(255, 255, 255, 0.2);
  }

  .cardRow {
    display: flex;
    gap: 15px;
  }

  .cardRow .formGroup {
    flex: 1;
  }

  .paymentSummary {
    background: rgba(0,0,0,0.3);
    padding: 20px;
    border-radius: 10px;
    margin: 20px 0;
    border: 2px solid rgba(255, 215, 0, 0.3);
  }

  .paymentSummary h3 {
    color: #ffd700;
    margin-bottom: 10px;
  }

  .paymentSummary p {
    margin: 5px 0;
    color: #fff;
  }

  .processPaymentBtn {
    width: 100%;
    background: linear-gradient(45deg, #28a745, #20c997);
    color: white;
    border: none;
    padding: 15px;
    border-radius: 10px;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 20px;
  }

  .processPaymentBtn:hover {
    background: linear-gradient(45deg, #218838, #1ea085);
    transform: scale(1.02);
  }

  .processPaymentBtn:disabled {
    background: #6c757d;
    cursor: not-allowed;
    transform: none;
  }

  .securityBadge {
    text-align: center;
    margin-top: 20px;
    color: rgba(255, 255, 255, 0.8);
    font-size: 14px;
  }

  .securityBadge i {
    color: #28a745;
    margin-right: 5px;
  }

  /* Mobile Payment Styles */
  @media (max-width: 768px) {
    .offersGrid {
      grid-template-columns: 1fr;
      gap: 15px;
    }

    .offerCard {
      padding: 15px;
    }

    .paymentModalContent {
      margin: 10% auto;
      padding: 20px;
      width: 95%;
    }

    .cardRow {
      flex-direction: column;
      gap: 10px;
    }
  }

  /* Online Room Styles */
  .onlineRoom {
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
    border: 3px solid #00d4ff;
    border-radius: 20px;
    padding: 30px;
    margin: 20px 0;
    box-shadow: 0 10px 40px rgba(0, 212, 255, 0.3);
    position: relative;
    overflow: hidden;
  }

  .onlineRoom::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent, rgba(0, 212, 255, 0.1), transparent);
    transform: rotate(45deg);
    animation: onlineShimmer 3s infinite;
  }

  @keyframes onlineShimmer {
    0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
    100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
  }

  .onlineRoom h2 {
    color: #00d4ff;
    font-size: 28px;
    text-align: center;
    margin-bottom: 20px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    position: relative;
    z-index: 1;
  }

  .roomStatus {
    background: rgba(0, 212, 255, 0.2);
    border: 2px solid #00d4ff;
    border-radius: 15px;
    padding: 20px;
    margin: 20px 0;
    text-align: center;
    color: white;
    position: relative;
    z-index: 1;
  }

  .roomStatus h3 {
    color: #00d4ff;
    margin-bottom: 15px;
    font-size: 20px;
  }

  .playerSlot {
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(0, 212, 255, 0.5);
    border-radius: 10px;
    padding: 15px;
    margin: 10px 0;
    display: flex;
    align-items: center;
    gap: 15px;
    transition: all 0.3s ease;
    position: relative;
    z-index: 1;
  }

  .playerSlot:hover {
    background: rgba(0, 212, 255, 0.2);
    border-color: #00d4ff;
    transform: translateY(-2px);
  }

  .playerSlot.ready {
    background: rgba(0, 255, 0, 0.2);
    border-color: #00ff00;
  }

  .playerSlot.waiting {
    background: rgba(255, 193, 7, 0.2);
    border-color: #ffc107;
  }

  .playerAvatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(45deg, #00d4ff, #0099cc);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: white;
    border: 3px solid rgba(255, 255, 255, 0.3);
  }

  .playerInfo {
    flex: 1;
    color: white;
  }

  .playerName {
    font-weight: bold;
    font-size: 16px;
    margin-bottom: 5px;
  }

  .playerStatus {
    font-size: 14px;
    opacity: 0.8;
  }

  .readyButton {
    background: linear-gradient(45deg, #00ff00, #00cc00);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 25px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    z-index: 1;
  }

  .readyButton:hover {
    background: linear-gradient(45deg, #00cc00, #009900);
    transform: scale(1.05);
  }

  .readyButton.ready {
    background: linear-gradient(45deg, #ff6b6b, #ff5252);
  }

  .readyButton.ready:hover {
    background: linear-gradient(45deg, #ff5252, #ff4444);
  }

  .onlineControls {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin: 20px 0;
    flex-wrap: wrap;
  }

  .onlineBtn {
    background: linear-gradient(45deg, #00d4ff, #0099cc);
    color: white;
    border: none;
    padding: 15px 25px;
    border-radius: 25px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    z-index: 1;
    min-width: 150px;
  }

  .onlineBtn:hover {
    background: linear-gradient(45deg, #0099cc, #0077aa);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 212, 255, 0.4);
  }

  .onlineBtn.create {
    background: linear-gradient(45deg, #4CAF50, #45a049);
  }

  .onlineBtn.create:hover {
    background: linear-gradient(45deg, #45a049, #3d8b40);
  }

  .onlineBtn.join {
    background: linear-gradient(45deg, #2196F3, #1976D2);
  }

  .onlineBtn.join:hover {
    background: linear-gradient(45deg, #1976D2, #1565C0);
  }

  .onlineBtn.start {
    background: linear-gradient(45deg, #FFD700, #FFA500);
    color: #000;
  }

  .onlineBtn.start:hover {
    background: linear-gradient(45deg, #FFA500, #FF8C00);
  }

  .onlineBtn:disabled {
    background: #6c757d;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  .chatContainer {
    background: rgba(0, 0, 0, 0.3);
    border: 2px solid rgba(0, 212, 255, 0.5);
    border-radius: 15px;
    padding: 20px;
    margin: 20px 0;
    position: relative;
    z-index: 1;
  }

  .chatContainer h3 {
    color: #00d4ff;
    margin-bottom: 15px;
    text-align: center;
  }

  .chatMessages {
    background: rgba(0, 0, 0, 0.5);
    border: 1px solid rgba(0, 212, 255, 0.3);
    border-radius: 10px;
    padding: 15px;
    height: 200px;
    overflow-y: auto;
    margin-bottom: 15px;
    color: white;
    font-family: monospace;
  }

  .chatInput {
    display: flex;
    gap: 10px;
  }

  .chatInput input {
    flex: 1;
    padding: 10px;
    border: 2px solid rgba(0, 212, 255, 0.5);
    border-radius: 25px;
    background: rgba(0, 0, 0, 0.3);
    color: white;
    font-size: 14px;
  }

  .chatInput input:focus {
    outline: none;
    border-color: #00d4ff;
    background: rgba(0, 0, 0, 0.5);
  }

  .chatInput input::placeholder {
    color: rgba(255, 255, 255, 0.6);
  }

  .chatSendBtn {
    background: linear-gradient(45deg, #00d4ff, #0099cc);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 25px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s ease;
  }

  .chatSendBtn:hover {
    background: linear-gradient(45deg, #0099cc, #0077aa);
    transform: scale(1.05);
  }

  .connectionStatus {
    text-align: center;
    padding: 10px;
    border-radius: 10px;
    margin: 10px 0;
    font-weight: bold;
  }

  .connectionStatus.connected {
    background: rgba(0, 255, 0, 0.2);
    color: #00ff00;
    border: 2px solid #00ff00;
  }

  .connectionStatus.disconnected {
    background: rgba(255, 0, 0, 0.2);
    color: #ff0000;
    border: 2px solid #ff0000;
  }

  .connectionStatus.connecting {
    background: rgba(255, 193, 7, 0.2);
    color: #ffc107;
    border: 2px solid #ffc107;
  }
</style>
</head>
<body>
<div id="menu">
  <h1 style="color:white; font-size: 40px;">Ninjago Battlegrounds</h1>
  <div style="color: white; margin: 20px 0; font-size: 18px;">
    üí∞ Cash: <span id="menuCash">1000</span> | üÜô Nivel: <span id="menuLevel">1</span> | üéØ IA: <span id="menuDifficulty">1</span>/10
  </div>
  <button onclick="startWorldSelect()">Start Battle</button>
  <button onclick="openShop()">Shop</button>
  <button onclick="startAdventureMode()" style="background: #4CAF50;">üèôÔ∏è Adventure Mode</button>
  <button onclick="startOnlineMode()" style="background: #2196F3;">üåê Online Mode</button>
</div>

<div id="shop" class="shop" style="display: none;">
  <h1 style="color:white; font-size: 40px;">üõí Tienda</h1>
  
  <div style="color: white; margin: 20px 0; font-size: 18px;">
    üí∞ Tu Cash: <span id="shopCash">1000</span>
  </div>
  
  <div class="shopSection">
    <h2 style="color: white;">üíé Comprar Cash</h2>
    <div class="cashPackages">
      <div class="cashPackage" onclick="buyCash(100000, 30)">
        <h3>üí∞ 100,000 Cash</h3>
        <p>Precio: $30 USD</p>
        <button class="buyButton">Comprar</button>
      </div>
      <div class="cashPackage" onclick="buyCash(50000, 15)">
        <h3>üí∞ 50,000 Cash</h3>
        <p>Precio: $15 USD</p>
        <button class="buyButton">Comprar</button>
      </div>
      <div class="cashPackage" onclick="buyCash(25000, 8)">
        <h3>üí∞ 25,000 Cash</h3>
        <p>Precio: $8 USD</p>
        <button class="buyButton">Comprar</button>
      </div>
    </div>
  </div>
  
  <div class="shopSection">
    <h2 style="color: white;">ü•∑ Personajes</h2>
    <div class="characterShop">
      <div class="shopCharacter" onclick="buyCharacter('ninjaAzul')">
        <img src="images/ChatGPT Image Sep 4, 2025, 03_29_16 PM-fotor-bg-remover-2025090415471.png" alt="Ninja Azul" id="ninjaAzulImage">
        <h3>Ninja Azul (Mujer)</h3>
        <p>Precio: 1,000 Cash</p>
        <div class="stats">
          <div class="stat">Attack: 28</div>
          <div class="stat">Defense: 18</div>
          <div class="stat">Health: 190</div>
        </div>
        <button class="buyButton" id="buyNinjaAzul">Comprar</button>
      </div>
    </div>
  </div>
  
  <div class="shopSection">
    <h2 style="color: white;">üéÅ Cajas de Habilidades</h2>
    <div class="skillBoxes">
      <div class="skillBox" onclick="buySkillBox('common')">
        <h3>üì¶ Caja Com√∫n</h3>
        <p>Contiene 1-3 habilidades aleatorias</p>
        <p>Precio: 500 Cash</p>
        <button class="buyButton">Comprar</button>
      </div>
      <div class="skillBox" onclick="buySkillBox('rare')">
        <h3>üì¶ Caja Rara</h3>
        <p>Contiene 2-4 habilidades raras</p>
        <p>Precio: 1,500 Cash</p>
        <button class="buyButton">Comprar</button>
      </div>
      <div class="skillBox" onclick="buySkillBox('epic')">
        <h3>üì¶ Caja √âpica</h3>
        <p>Contiene 3-5 habilidades √©picas</p>
        <p>Precio: 3,000 Cash</p>
        <button class="buyButton">Comprar</button>
      </div>
      <div class="skillBox" onclick="buySkillBox('legendary')">
        <h3>üì¶ Caja Legendaria</h3>
        <p>Contiene 4-6 habilidades legendarias</p>
        <p>Precio: 7,500 Cash</p>
        <button class="buyButton">Comprar</button>
      </div>
    </div>
  </div>
  
  <div class="shopSection">
    <h2 style="color: white;">‚ö° Habilidades Disponibles</h2>
    <div class="availableSkills">
      <div class="skillItem">
        <h4>üî• Fuego Mejorado</h4>
        <p>Aumenta el da√±o de fuego en 25%</p>
        <p>Precio: 800 Cash</p>
        <button class="buyButton" onclick="buySkill('fireBoost')">Comprar</button>
      </div>
      <div class="skillItem">
        <h4>‚ùÑÔ∏è Hielo Mejorado</h4>
        <p>Aumenta el da√±o de hielo en 25%</p>
        <p>Precio: 800 Cash</p>
        <button class="buyButton" onclick="buySkill('iceBoost')">Comprar</button>
      </div>
      <div class="skillItem">
        <h4>‚ö° Rayo Mejorado</h4>
        <p>Aumenta el da√±o de rayo en 25%</p>
        <p>Precio: 800 Cash</p>
        <button class="buyButton" onclick="buySkill('lightningBoost')">Comprar</button>
      </div>
      <div class="skillItem">
        <h4>üíö Energ√≠a Mejorada</h4>
        <p>Aumenta el da√±o de energ√≠a en 25%</p>
        <p>Precio: 800 Cash</p>
        <button class="buyButton" onclick="buySkill('energyBoost')">Comprar</button>
      </div>
    </div>
  </div>
  
  <div class="shopSection">
    <h2 style="color: white;">üéØ Tus Habilidades Activas</h2>
    <div id="activeSkills" class="activeSkills">
      <p style="color: #ccc; text-align: center;">No tienes habilidades activas</p>
    </div>
  </div>
  
  <!-- Real Money Offers Section -->
  <div class="offersSection">
    <h2>üíé OFERTAS ESPECIALES - PAGO REAL</h2>
    <p style="color: white; margin-bottom: 20px;">¬°Obt√©n ventajas exclusivas con dinero real!</p>
    
    <div class="offersGrid">
      <div class="offerCard" onclick="openPaymentModal('starter', 4.99, 'Paquete Iniciador', 'üí∞ 100,000 Cash\nüì¶ 5 Cajas Raras (2-4 habilidades raras cada una)\nü•∑ Personaje Exclusivo: Nya (Water Ninja)\n‚ö° Habilidades especiales de agua\nüéØ Perfecto para principiantes')">
        <div class="offerBadge">¬°NUEVO!</div>
        <div class="offerTitle">üöÄ Paquete Iniciador</div>
        <div class="offerDescription">üí∞ 100,000 Cash<br>üì¶ 5 Cajas Raras<br>ü•∑ Personaje Exclusivo: Nya<br>‚ö° Habilidades de agua</div>
        <div class="offerPrice">$4.99 USD</div>
        <div class="offerValue">Valor: $15.99</div>
        <button class="buyButton">Comprar Ahora</button>
      </div>
      
      <div class="offerCard" onclick="openPaymentModal('premium', 9.99, 'Paquete Premium', 'üí∞ 250,000 Cash\nüì¶ 10 Cajas √âpicas (3-5 habilidades √©picas cada una)\nü•∑ 2 Personajes Exclusivos: Nya + Master Wu\n‚ö° Habilidades de agua y fuego\nüèÜ Ventajas en batalla\nüëë Para jugadores serios')">
        <div class="offerBadge">¬°POPULAR!</div>
        <div class="offerTitle">üëë Paquete Premium</div>
        <div class="offerDescription">üí∞ 250,000 Cash<br>üì¶ 10 Cajas √âpicas<br>ü•∑ 2 Personajes Exclusivos<br>‚ö° Habilidades especiales</div>
        <div class="offerPrice">$9.99 USD</div>
        <div class="offerValue">Valor: $35.99</div>
        <button class="buyButton">Comprar Ahora</button>
      </div>
      
      <div class="offerCard" onclick="openPaymentModal('legendary', 19.99, 'Paquete Legendario', 'üí∞ 500,000 Cash\nüì¶ 20 Cajas Legendarias (4-6 habilidades legendarias cada una)\nü•∑ TODOS los Personajes Desbloqueados\n‚ö° Todas las habilidades especiales\nüíé Membres√≠a VIP por 30 d√≠as\nüåü Ventajas exclusivas en torneos\nüèÜ Para verdaderos maestros ninja')">
        <div class="offerBadge">¬°LIMITADO!</div>
        <div class="offerTitle">üåü Paquete Legendario</div>
        <div class="offerDescription">üí∞ 500,000 Cash<br>üì¶ 20 Cajas Legendarias<br>ü•∑ TODOS los Personajes<br>üíé VIP 30 d√≠as</div>
        <div class="offerPrice">$19.99 USD</div>
        <div class="offerValue">Valor: $79.99</div>
        <button class="buyButton">Comprar Ahora</button>
      </div>
      
      <div class="offerCard" onclick="openPaymentModal('cash', 2.99, 'Cash R√°pido', 'üí∞ 50,000 Cash instant√°neo\n‚ö° Se agrega inmediatamente a tu cuenta\nüõí √ösalo para comprar habilidades y personajes\nüí≥ Pago r√°pido y seguro')">
        <div class="offerTitle">üí∞ Cash R√°pido</div>
        <div class="offerDescription">üí∞ 50,000 Cash<br>‚ö° Instant√°neo<br>üõí Para compras</div>
        <div class="offerPrice">$2.99 USD</div>
        <div class="offerValue">50,000 Cash</div>
        <button class="buyButton">Comprar Ahora</button>
      </div>
      
      <div class="offerCard" onclick="openPaymentModal('character', 1.99, 'Personaje Exclusivo', 'ü•∑ Personaje Exclusivo: Nya (Water Ninja)\nüí∞ 10,000 Cash de bonificaci√≥n\n‚ö° Habilidades especiales de agua\nüåä Ataques √∫nicos de agua\nüéØ Desbloqueo permanente')">
        <div class="offerTitle">ü•∑ Personaje Exclusivo</div>
        <div class="offerDescription">ü•∑ Nya (Water Ninja)<br>üí∞ 10,000 Cash<br>‚ö° Habilidades agua</div>
        <div class="offerPrice">$1.99 USD</div>
        <div class="offerValue">Personaje + 10,000 Cash</div>
        <button class="buyButton">Comprar Ahora</button>
      </div>
      
      <div class="offerCard" onclick="openPaymentModal('vip', 7.99, 'Membres√≠a VIP', 'üíé Membres√≠a VIP por 30 d√≠as\nüí∞ 100,000 Cash de bienvenida\nüåü Ventajas exclusivas en torneos\n‚ö° Experiencia doble en batallas\nüèÜ Acceso a salas VIP\nüëë T√≠tulo especial en el juego')">
        <div class="offerBadge">¬°VIP!</div>
        <div class="offerTitle">üíé Membres√≠a VIP</div>
        <div class="offerDescription">üíé VIP 30 d√≠as<br>üí∞ 100,000 Cash<br>üåü Ventajas exclusivas</div>
        <div class="offerPrice">$7.99 USD</div>
        <div class="offerValue">100,000 Cash + Ventajas VIP</div>
        <button class="buyButton">Comprar Ahora</button>
      </div>
    </div>
  </div>
  
  <button onclick="backToMenuFromShop()" style="margin-top: 20px; padding: 10px 20px; background: #666;">Volver al Men√∫</button>
</div>

<div id="adventureMode" class="adventureMode" style="display: none;">
  <h1 style="color:white; font-size: 40px;">üèôÔ∏è Modo Aventura - Ciudad Ninja</h1>
  
  <div style="color: white; margin: 20px 0; font-size: 18px;">
    üí∞ Cash: <span id="adventureCash">1000</span> | üÜô Nivel: <span id="adventureLevel">1</span> | üéØ Dificultad IA: <span id="adventureDifficulty">1</span>/10
  </div>
  
  <div class="cityMap">
    <div class="cityDistrict">
      <h3 style="color: #FFD700;">üèõÔ∏è Distrito Central</h3>
      <div class="building" onclick="enterTournament('central', 'easy')">
        <div class="buildingIcon">üè¢</div>
        <h4>Torre del Comercio</h4>
        <p>Torneo F√°cil - 3 oponentes</p>
        <div class="tournamentInfo">
          <span class="difficulty easy">F√°cil</span>
          <span class="reward">üí∞ 150 cash</span>
        </div>
      </div>
      
      <div class="building" onclick="enterTournament('central', 'medium')">
        <div class="buildingIcon">üèõÔ∏è</div>
        <h4>Palacio del Gobierno</h4>
        <p>Torneo Intermedio - 3 oponentes</p>
        <div class="tournamentInfo">
          <span class="difficulty medium">Intermedio</span>
          <span class="reward">üí∞ 300 cash</span>
        </div>
      </div>
      
      <div class="building" onclick="enterTournament('central', 'hard')">
        <div class="buildingIcon">üóº</div>
        <h4>Torre del Maestro</h4>
        <p>Torneo Dif√≠cil - 3 oponentes</p>
        <div class="tournamentInfo">
          <span class="difficulty hard">Dif√≠cil</span>
          <span class="reward">üí∞ 500 cash</span>
        </div>
      </div>
    </div>
    
    <div class="cityDistrict">
      <h3 style="color: #87CEEB;">üåä Distrito del Puerto</h3>
      <div class="building" onclick="enterTournament('harbor', 'easy')">
        <div class="buildingIcon">‚öì</div>
        <h4>Muelle de los Pescadores</h4>
        <p>Torneo F√°cil - 3 oponentes</p>
        <div class="tournamentInfo">
          <span class="difficulty easy">F√°cil</span>
          <span class="reward">üí∞ 150 cash</span>
        </div>
      </div>
      
      <div class="building" onclick="enterTournament('harbor', 'medium')">
        <div class="buildingIcon">üö¢</div>
        <h4>Puerto Comercial</h4>
        <p>Torneo Intermedio - 3 oponentes</p>
        <div class="tournamentInfo">
          <span class="tournamentInfo">
            <span class="difficulty medium">Intermedio</span>
            <span class="reward">üí∞ 300 cash</span>
          </span>
        </div>
      </div>
      
      <div class="building" onclick="enterTournament('harbor', 'hard')">
        <div class="buildingIcon">üè∞</div>
        <h4>Fortaleza Mar√≠tima</h4>
        <p>Torneo Dif√≠cil - 3 oponentes</p>
        <div class="tournamentInfo">
          <span class="difficulty hard">Dif√≠cil</span>
          <span class="reward">üí∞ 500 cash</span>
        </div>
      </div>
    </div>
    
    <div class="cityDistrict">
      <h3 style="color: #98FB98;">üåø Distrito de la Naturaleza</h3>
      <div class="building" onclick="enterTournament('nature', 'easy')">
        <div class="buildingIcon">üå≥</div>
        <h4>Parque Central</h4>
        <p>Torneo F√°cil - 3 oponentes</p>
        <div class="tournamentInfo">
          <span class="difficulty easy">F√°cil</span>
          <span class="reward">üí∞ 150 cash</span>
        </div>
      </div>
      
      <div class="building" onclick="enterTournament('nature', 'medium')">
        <div class="buildingIcon">üèûÔ∏è</div>
        <h4>Jardines Bot√°nicos</h4>
        <p>Torneo Intermedio - 3 oponentes</p>
        <div class="tournamentInfo">
          <span class="difficulty medium">Intermedio</span>
          <span class="reward">üí∞ 300 cash</span>
        </div>
      </div>
      
      <div class="building" onclick="enterTournament('nature', 'hard')">
        <div class="buildingIcon">üå≤</div>
        <h4>Bosque Sagrado</h4>
        <p>Torneo Dif√≠cil - 3 oponentes</p>
        <div class="tournamentInfo">
          <span class="difficulty hard">Dif√≠cil</span>
          <span class="reward">üí∞ 500 cash</span>
        </div>
      </div>
    </div>
  </div>
  
  <button onclick="backToMenuFromAdventure()" style="margin-top: 20px; padding: 10px 20px; background: #666;">Volver al Men√∫</button>
</div>

<!-- Modo Online -->
<div id="onlineMode" class="onlineMode" style="display: none;">
  <h1 style="color:white; font-size: 40px;">üåê Modo Online</h1>
  
  <div style="color: white; margin: 20px 0; font-size: 18px; text-align: center;">
    üí∞ Tu Cash: <span id="onlineCash">1000</span>
  </div>
  
  <!-- Sala Online Mejorada -->
  <div class="onlineRoom">
    <h2>üè† Sala de Batalla Online</h2>
    
    <!-- Estado de Conexi√≥n -->
    <div class="connectionStatus connected" id="connectionStatus">
      üîó Conectado al servidor
    </div>
    
    <!-- Controles de Sala -->
    <div class="onlineControls">
      <input type="text" id="roomIdInput" placeholder="ID de Sala (ej: ABC123)" style="padding: 15px; border: 2px solid #00d4ff; border-radius: 25px; background: rgba(0,0,0,0.3); color: white; font-size: 16px; min-width: 200px;">
      <button class="onlineBtn create" onclick="createRoom()">üè† Crear Sala</button>
      <button class="onlineBtn join" onclick="joinRoom()">üö™ Unirse a Sala</button>
    </div>
    
    <!-- Estado de la Sala -->
    <div class="roomStatus" id="roomStatus" style="display: none;">
      <h3>üéØ Estado de la Sala</h3>
      <div id="roomInfo">
        <p><strong>ID de Sala:</strong> <span id="currentRoomId">-</span></p>
        <p><strong>Jugadores:</strong> <span id="playerCount">0/2</span></p>
        <p><strong>Estado:</strong> <span id="roomState">Esperando jugadores...</span></p>
      </div>
    </div>
    
    <!-- Lista de Jugadores -->
    <div class="roomStatus">
      <h3>üë• Jugadores en Sala</h3>
      <div id="onlinePlayerList">
        <div class="playerSlot waiting">
          <div class="playerAvatar">ü•∑</div>
          <div class="playerInfo">
            <div class="playerName">Esperando jugador...</div>
            <div class="playerStatus">Slot vac√≠o</div>
          </div>
          <button class="readyButton" disabled>Esperando</button>
        </div>
        <div class="playerSlot waiting">
          <div class="playerAvatar">ü•∑</div>
          <div class="playerInfo">
            <div class="playerName">Esperando jugador...</div>
            <div class="playerStatus">Slot vac√≠o</div>
          </div>
          <button class="readyButton" disabled>Esperando</button>
        </div>
      </div>
    </div>
    
    <!-- Selecci√≥n de Personaje Online -->
    <div class="roomStatus">
      <h3>ü•∑ Seleccionar Personaje</h3>
      <div id="onlineCharacterSelect" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 15px;">
        <!-- Los personajes se cargar√°n din√°micamente -->
      </div>
    </div>
    
    <!-- Chat Mejorado -->
    <div class="chatContainer">
      <h3>üí¨ Chat de Sala</h3>
      <div class="chatMessages" id="chatMessages">
        <div style="color: #00d4ff; text-align: center; margin: 20px 0;">
          üåü ¬°Bienvenido a la sala de batalla! üåü<br>
          Chatea con otros jugadores mientras esperas...
        </div>
      </div>
      <div class="chatInput">
        <input type="text" id="chatInput" placeholder="Escribe tu mensaje..." maxlength="100">
        <button class="chatSendBtn" onclick="sendOnlineMessage()">üì§</button>
      </div>
    </div>
    
    <!-- Controles de Juego -->
    <div class="onlineControls">
      <button class="onlineBtn start" id="startOnlineGameBtn" onclick="startOnlineGame()" disabled>
        ‚öîÔ∏è Iniciar Batalla
      </button>
    </div>
  </div>

  <button onclick="backToMenuFromOnline()" style="margin-top: 20px; padding: 15px 30px; background: linear-gradient(45deg, #666, #555); color: white; border: none; border-radius: 25px; font-weight: bold; cursor: pointer; transition: all 0.3s ease;">üè† Volver al Men√∫</button>
</div>

<div id="worldSelect" class="worldSelect">
  <h1 style="color:white; font-size: 40px;">Choose Your Battle World</h1>
  <div class="worldGrid">
    <div class="worldCard" onclick="selectWorld('ice')">
                  <img src="images/iceworld.png.png" alt="Ice World">
      <h3>‚ùÑÔ∏è Ice World</h3>
      <p>Frozen battleground with crystal spires</p>
    </div>
    <div class="worldCard" onclick="selectWorld('lava')">
                  <img src="images/mundolava.png.png" alt="Lava World">
      <h3>üåã Lava World</h3>
      <p>Volcanic terrain with flowing lava</p>
    </div>
    <div class="worldCard" onclick="selectWorld('jungle')">
                  <img src="images/ChatGPT Image Sep 4, 2025, 03_07_48 PM.png" alt="Jungle World">
      <h3>üåø Jungle World</h3>
      <p>Dense jungle with ancient ruins</p>
    </div>
    <div class="worldCard" onclick="selectWorld('legoCity')">
      <img src="images/ciudad lego.jpg" alt="Lego City">
      <h3>üèôÔ∏è Lego City</h3>
      <p>Vibrant Lego city with tournaments and adventures</p>
    </div>
  </div>
  <button onclick="backToMenu()" style="margin-top: 20px; padding: 10px 20px; background: #666;">Back to Menu</button>
</div>

<div id="characterSelect" class="characterSelect">
  <h1 style="color:white; font-size: 40px;">Choose Your Ninja</h1>
  <div class="characterGrid">
    <div class="characterCard" onclick="selectCharacter('kai')">
                  <img src="images/ninjarojosinmascara.png.png" alt="Kai">
      <h3>Kai (Red Ninja)</h3>
      <p>Master of Fire</p>
      <div class="stats">
        <div class="stat">
          <div class="stat-value">25</div>
          <div>Attack</div>
        </div>
        <div class="stat">
          <div class="stat-value">15</div>
          <div>Defense</div>
        </div>
        <div class="stat">
          <div class="stat-value">200</div>
          <div>Health</div>
        </div>
      </div>
    </div>
    <div class="characterCard" onclick="selectCharacter('zane')">
                  <img src="images/ninjablanco.png-fotor-bg-remover-20250902204741.png" alt="Zane">
      <h3>Zane (White Ninja)</h3>
      <p>Master of Ice</p>
      <div class="stats">
        <div class="stat">
          <div class="stat-value">20</div>
          <div>Attack</div>
        </div>
        <div class="stat">
          <div class="stat-value">20</div>
          <div>Defense</div>
        </div>
        <div class="stat">
          <div class="stat-value">180</div>
          <div>Health</div>
        </div>
      </div>
    </div>
    <div class="characterCard" onclick="selectCharacter('jay')">
                  <img src="images/ninjaazul.png-fotor-bg-remover-20250902204441.png" alt="Jay">
      <h3>Jay (Blue Ninja)</h3>
      <p>Master of Lightning</p>
      <div class="stats">
        <div class="stat">
          <div class="stat-value">30</div>
          <div>Attack</div>
        </div>
        <div class="stat">
          <div class="stat-value">10</div>
          <div>Defense</div>
        </div>
        <div class="stat">
          <div class="stat-value">160</div>
          <div>Health</div>
        </div>
      </div>
    </div>
    <div class="characterCard" onclick="selectCharacter('lloyd')">
                  <img src="images/ChatGPT Image Sep 2, 2025, 09_04_04 PM-fotor-bg-remover-2025090221451.png" alt="Lloyd">
      <h3>Lloyd (Green Ninja)</h3>
      <p>Master of Energy</p>
      <div class="stats">
        <div class="stat">
          <div class="stat-value">35</div>
          <div>Attack</div>
        </div>
        <div class="stat">
          <div class="stat-value">5</div>
          <div>Defense</div>
        </div>
        <div class="stat">
          <div class="stat-value">250</div>
          <div>Health</div>
        </div>
      </div>
    </div>
    <div class="characterCard" onclick="selectCharacter('ninjaAzul')" id="ninjaAzulCard">
      <img src="images/ChatGPT Image Sep 4, 2025, 03_29_16 PM-fotor-bg-remover-2025090415471.png" alt="Nya">
      <h3>Nya (Water Ninja)</h3>
      <p>Master of Water</p>
      <div class="stats">
        <div class="stat">
          <div class="stat-value">28</div>
          <div>Attack</div>
        </div>
        <div class="stat">
          <div class="stat-value">18</div>
          <div>Defense</div>
        </div>
        <div class="stat">
          <div class="stat-value">190</div>
          <div>Health</div>
        </div>
      </div>
      <div class="locked-overlay" id="ninjaAzulLocked" style="display: none;">
        <span>üîí Locked</span>
      </div>
    </div>
  </div>
  <button onclick="backToWorldSelect()" style="margin-top: 20px; padding: 10px 20px; background: #666;">Back to World Select</button>
</div>

<canvas id="gameCanvas"></canvas>

<!-- Mobile Controls -->
<div id="mobileControls">
  <div class="controlRow">
    <div class="dpad">
      <div></div>
      <button id="upBtn" onmousedown="mobileKeyDown('w')" onmouseup="mobileKeyUp('w')" ontouchstart="mobileKeyDown('w')" ontouchend="mobileKeyUp('w')">‚Üë</button>
      <div></div>
      <button id="leftBtn" onmousedown="mobileKeyDown('a')" onmouseup="mobileKeyUp('a')" ontouchstart="mobileKeyDown('a')" ontouchend="mobileKeyUp('a')">‚Üê</button>
      <div></div>
      <button id="rightBtn" onmousedown="mobileKeyDown('d')" onmouseup="mobileKeyUp('d')" ontouchstart="mobileKeyDown('d')" ontouchend="mobileKeyUp('d')">‚Üí</button>
      <div></div>
      <button id="downBtn" onmousedown="mobileKeyDown('s')" onmouseup="mobileKeyUp('s')" ontouchstart="mobileKeyDown('s')" ontouchend="mobileKeyUp('s')">‚Üì</button>
      <div></div>
    </div>
    <div class="actionButtons">
      <button class="actionBtn" id="jumpBtn" onmousedown="mobileKeyDown(' ')" onmouseup="mobileKeyUp(' ')" ontouchstart="mobileKeyDown(' ')" ontouchend="mobileKeyUp(' ')">JUMP</button>
      <button class="actionBtn" id="attackBtn" onmousedown="mobileKeyDown('j')" onmouseup="mobileKeyUp('j')" ontouchstart="mobileKeyDown('j')" ontouchend="mobileKeyUp('j')">ATTACK</button>
    </div>
  </div>
</div>

<!-- Payment Modal -->
<div id="paymentModal" class="paymentModal">
  <div class="paymentModalContent">
    <span class="closePayment" onclick="closePaymentModal()">&times;</span>
    <div class="paymentForm">
      <h2>üí≥ Procesar Pago</h2>
      
      <div class="paymentSummary">
        <h3>Resumen de Compra</h3>
        <p id="paymentItem">-</p>
        <p id="paymentDescription">-</p>
        <p><strong>Total: <span id="paymentTotal">$0.00</span></strong></p>
      </div>
      
      <form id="paymentForm">
        <div class="formGroup">
          <label for="cardNumber">N√∫mero de Tarjeta</label>
          <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19" required>
        </div>
        
        <div class="formGroup">
          <label for="cardName">Nombre en la Tarjeta</label>
          <input type="text" id="cardName" placeholder="Juan P√©rez" required>
        </div>
        
        <div class="cardRow">
          <div class="formGroup">
            <label for="expiryDate">Fecha de Vencimiento</label>
            <input type="text" id="expiryDate" placeholder="MM/AA" maxlength="5" required>
          </div>
          <div class="formGroup">
            <label for="cvv">CVV</label>
            <input type="text" id="cvv" placeholder="123" maxlength="4" required>
          </div>
        </div>
        
        <div class="formGroup">
          <label for="cardType">Tipo de Tarjeta</label>
          <select id="cardType" required>
            <option value="">Seleccionar tipo</option>
            <option value="visa">Visa</option>
            <option value="mastercard">Mastercard</option>
            <option value="amex">American Express</option>
            <option value="discover">Discover</option>
          </select>
        </div>
        
        <div class="formGroup">
          <label for="email">Email</label>
          <input type="email" id="email" placeholder="tu@email.com" required>
        </div>
        
        <button type="submit" class="processPaymentBtn" id="processPaymentBtn">
          üîí Procesar Pago Seguro
        </button>
      </form>
      
      <div class="securityBadge">
        <i>üîí</i> Pago 100% Seguro - Encriptaci√≥n SSL
      </div>
    </div>
  </div>
</div>

<div id="gameUI" style="display: none;">
  <h3>Battle Status</h3>
  <div id="player1Info">
    <div>Player 1: <span id="player1Name">-</span></div>
    <div class="healthBar">
      <div class="healthFill" id="player1Health" style="width: 100%"></div>
    </div>
  </div>
  <div id="player2Info">
    <div>Player 2: <span id="player2Name">-</span></div>
    <div class="healthBar">
      <div class="healthFill" id="player2Health" style="width: 100%"></div>
    </div>
  </div>
</div>

<div id="worldInfo" class="worldInfo" style="display: none;">
  <h4>üåç World</h4>
  <div id="worldName">-</div>
</div>

<div class="controls" style="display: none;">
  <h4>üéÆ Controls</h4>
  <div class="control-row">
    <span>Move:</span>
    <span class="key">WASD</span> or <span class="key">‚Üë‚Üì‚Üê‚Üí</span>
  </div>
  <div class="control-row">
    <span>Attack:</span>
    <span class="key">CTRL</span>
  </div>
  <div class="control-row">
    <span>Special:</span>
    <span class="key">ENTER</span>
  </div>
  <div class="control-row">
    <span>Jump:</span>
    <span class="key">SPACE</span>
  </div>
  <div class="control-row">
    <span>Shield:</span>
    <span class="key">SHIFT</span>
  </div>
</div>

  <script src="animations.js"></script>
  <script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// Mobile touch control functions
function mobileKeyDown(key) {
  keys[key.toLowerCase()] = true;
  console.log("Mobile key pressed:", key.toLowerCase());
}

function mobileKeyUp(key) {
  keys[key.toLowerCase()] = false;
  console.log("Mobile key released:", key.toLowerCase());
}

// Prevent default touch behaviors for mobile controls
document.addEventListener('touchstart', function(e) {
  if (e.target.closest('#mobileControls')) {
    e.preventDefault();
  }
}, { passive: false });

document.addEventListener('touchend', function(e) {
  if (e.target.closest('#mobileControls')) {
    e.preventDefault();
  }
}, { passive: false });

// Detect mobile device
function isMobileDevice() {
  return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
         (window.innerWidth <= 768);
}

// Show/hide mobile controls based on device
function toggleMobileControls() {
  const mobileControls = document.getElementById('mobileControls');
  if (isMobileDevice()) {
    mobileControls.style.display = 'block';
    // Adjust canvas height for mobile controls
    canvas.style.height = 'calc(100vh - 120px)';
  } else {
    mobileControls.style.display = 'none';
    canvas.style.height = '100vh';
  }
}

// Payment System Functions
let currentOffer = null;

function openPaymentModal(offerType, price, title, description) {
  currentOffer = { type: offerType, price: price, title: title, description: description };
  
  document.getElementById('paymentItem').textContent = title;
  document.getElementById('paymentDescription').textContent = description;
  document.getElementById('paymentTotal').textContent = `$${price.toFixed(2)} USD`;
  
  document.getElementById('paymentModal').style.display = 'block';
  
  // Reset form
  document.getElementById('paymentForm').reset();
}

function closePaymentModal() {
  document.getElementById('paymentModal').style.display = 'none';
  currentOffer = null;
}

// Format card number with spaces
function formatCardNumber(input) {
  let value = input.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
  let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
  if (formattedValue !== input.value) {
    input.value = formattedValue;
  }
}

// Format expiry date
function formatExpiryDate(input) {
  let value = input.value.replace(/\D/g, '');
  if (value.length >= 2) {
    value = value.substring(0, 2) + '/' + value.substring(2, 4);
  }
  input.value = value;
}

// Validate card number (Luhn algorithm)
function validateCardNumber(cardNumber) {
  const cleanNumber = cardNumber.replace(/\s/g, '');
  if (!/^\d{13,19}$/.test(cleanNumber)) return false;
  
  let sum = 0;
  let isEven = false;
  
  for (let i = cleanNumber.length - 1; i >= 0; i--) {
    let digit = parseInt(cleanNumber[i]);
    
    if (isEven) {
      digit *= 2;
      if (digit > 9) {
        digit -= 9;
      }
    }
    
    sum += digit;
    isEven = !isEven;
  }
  
  return sum % 10 === 0;
}

// Validate email
function validateEmail(email) {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email);
}

// Validate expiry date
function validateExpiryDate(expiryDate) {
  const [month, year] = expiryDate.split('/');
  if (!month || !year) return false;
  
  const currentDate = new Date();
  const currentYear = currentDate.getFullYear() % 100;
  const currentMonth = currentDate.getMonth() + 1;
  
  const expMonth = parseInt(month);
  const expYear = parseInt(year);
  
  if (expMonth < 1 || expMonth > 12) return false;
  if (expYear < currentYear) return false;
  if (expYear === currentYear && expMonth < currentMonth) return false;
  
  return true;
}

// Process payment
function processPayment(event) {
  event.preventDefault();
  
  if (!currentOffer) {
    alert('Error: No hay oferta seleccionada');
    return;
  }
  
  const cardNumber = document.getElementById('cardNumber').value;
  const cardName = document.getElementById('cardName').value;
  const expiryDate = document.getElementById('expiryDate').value;
  const cvv = document.getElementById('cvv').value;
  const cardType = document.getElementById('cardType').value;
  const email = document.getElementById('email').value;
  
  // Validate form
  if (!cardNumber || !cardName || !expiryDate || !cvv || !cardType || !email) {
    alert('Por favor, completa todos los campos');
    return;
  }
  
  if (!validateCardNumber(cardNumber)) {
    alert('N√∫mero de tarjeta inv√°lido');
    return;
  }
  
  if (!validateExpiryDate(expiryDate)) {
    alert('Fecha de vencimiento inv√°lida');
    return;
  }
  
  if (!validateEmail(email)) {
    alert('Email inv√°lido');
    return;
  }
  
  if (cvv.length < 3 || cvv.length > 4) {
    alert('CVV inv√°lido');
    return;
  }
  
  // Disable button and show processing
  const processBtn = document.getElementById('processPaymentBtn');
  processBtn.disabled = true;
  processBtn.textContent = 'üîÑ Procesando...';
  
  // Simulate payment processing
  setTimeout(() => {
    // Simulate successful payment
    const success = Math.random() > 0.1; // 90% success rate for demo
    
    if (success) {
      // Process the purchase
      processPurchase(currentOffer);
      
      // Show success message
      alert(`üéâ ¬°Pago exitoso!\n\nHas comprado: ${currentOffer.title}\n\nLos items han sido agregados a tu cuenta.`);
      
      // Close modal
      closePaymentModal();
    } else {
      // Show error message
      alert('‚ùå Error en el pago\n\nPor favor, verifica tu informaci√≥n y intenta nuevamente.');
    }
    
    // Reset button
    processBtn.disabled = false;
    processBtn.textContent = 'üîí Procesar Pago Seguro';
  }, 2000);
}

// Process the actual purchase
function processPurchase(offer) {
  switch (offer.type) {
    case 'starter':
      playerCash += 100000;
      // Add 5 rare skill boxes
      for (let i = 0; i < 5; i++) {
        buySkillBox('rare');
      }
      // Unlock exclusive character
      unlockExclusiveCharacter('ninjaAzul');
      break;
      
    case 'premium':
      playerCash += 250000;
      // Add 10 epic skill boxes
      for (let i = 0; i < 10; i++) {
        buySkillBox('epic');
      }
      // Unlock 2 exclusive characters
      unlockExclusiveCharacter('ninjaAzul');
      unlockExclusiveCharacter('masterWu');
      break;
      
    case 'legendary':
      playerCash += 500000;
      // Add 20 legendary skill boxes
      for (let i = 0; i < 20; i++) {
        buySkillBox('legendary');
      }
      // Unlock all characters
      unlockAllCharacters();
      // Activate VIP status
      activateVIP();
      break;
      
    case 'cash':
      playerCash += 50000;
      break;
      
    case 'character':
      playerCash += 10000;
      unlockExclusiveCharacter('ninjaAzul');
      break;
      
    case 'vip':
      playerCash += 100000;
      activateVIP();
      break;
  }
  
  // Save to localStorage
  localStorage.setItem('playerCash', playerCash.toString());
  
  // Update UI
  if (document.getElementById("shopCash")) {
    document.getElementById("shopCash").textContent = playerCash;
  }
  if (document.getElementById("menuCash")) {
    document.getElementById("menuCash").textContent = playerCash;
  }
  
  // Update shop info
  updateShopInfo();
}

// Unlock exclusive character
function unlockExclusiveCharacter(characterId) {
  let unlockedCharacters = JSON.parse(localStorage.getItem('unlockedCharacters') || '[]');
  if (!unlockedCharacters.includes(characterId)) {
    unlockedCharacters.push(characterId);
    localStorage.setItem('unlockedCharacters', JSON.stringify(unlockedCharacters));
  }
}

// Unlock all characters
function unlockAllCharacters() {
  const allCharacters = ['kai', 'zane', 'jay', 'lloyd', 'ninjaAzul', 'masterWu'];
  localStorage.setItem('unlockedCharacters', JSON.stringify(allCharacters));
}

// Activate VIP status
function activateVIP() {
  const vipExpiry = new Date();
  vipExpiry.setDate(vipExpiry.getDate() + 30); // 30 days
  localStorage.setItem('vipExpiry', vipExpiry.toISOString());
  localStorage.setItem('vipActive', 'true');
}

// Game state
let gameState = "menu"; // "menu", "worldSelect", "characterSelect", "battle"
let selectedWorld = null;
let selectedCharacter = null;

// Animation system
let animationFrame = 0;
let animationSpeed = 0.3; // Velocidad de animaci√≥n (frames por segundo) - Mejorada para fluidez
let lastAnimationUpdate = 0;

// Character animation sprites - Updated with no-background images
// Las im√°genes de caminata (ChatGPT Image Sep 8, 2025, 06_32_XX PM.png) son sin fondo
// Esto permite que las animaciones se vean profesionales y se integren perfectamente con el escenario
const characterAnimations = {
  kai: {
    idle: ['images/ninjarojosinmascara.png.png'],
    walk: [
      'images/ninjarojosinmascara.png.png',
      'images/ChatGPT Image Sep 8, 2025, 06_32_56 PM.png',
      'images/ChatGPT Image Sep 8, 2025, 06_32_59 PM.png',
      'images/ChatGPT Image Sep 8, 2025, 06_33_02 PM.png'
    ],
    attack: ['images/ninjarojosinmascara.png.png'],
    special: ['images/ninjarojosinmascara.png.png']
  },
  zane: {
    idle: ['images/ninjablanco.png-fotor-bg-remover-20250902204741.png'],
    walk: [
      'images/ninjablanco.png-fotor-bg-remover-20250902204741.png',
      'images/ChatGPT Image Sep 8, 2025, 06_32_56 PM.png',
      'images/ChatGPT Image Sep 8, 2025, 06_32_59 PM.png',
      'images/ChatGPT Image Sep 8, 2025, 06_33_02 PM.png'
    ],
    attack: ['images/ninjablanco.png-fotor-bg-remover-20250902204741.png'],
    special: ['images/ninjablanco.png-fotor-bg-remover-20250902204741.png']
  },
  jay: {
    idle: ['images/ninjaazul.png-fotor-bg-remover-20250902204441.png'],
    walk: [
      'images/ninjaazul.png-fotor-bg-remover-20250902204441.png',
      'images/ChatGPT Image Sep 8, 2025, 06_32_56 PM.png',
      'images/ChatGPT Image Sep 8, 2025, 06_32_59 PM.png',
      'images/ChatGPT Image Sep 8, 2025, 06_33_02 PM.png'
    ],
    attack: ['images/ninjaazul.png-fotor-bg-remover-20250902204441.png'],
    special: ['images/ninjaazul.png-fotor-bg-remover-20250902204441.png']
  },
  lloyd: {
    idle: ['images/ChatGPT Image Sep 2, 2025, 09_04_04 PM-fotor-bg-remover-2025090221451.png'],
    walk: [
      'images/ChatGPT Image Sep 2, 2025, 09_04_04 PM-fotor-bg-remover-2025090221451.png',
      'images/ChatGPT Image Sep 8, 2025, 06_32_56 PM.png',
      'images/ChatGPT Image Sep 8, 2025, 06_32_59 PM.png',
      'images/ChatGPT Image Sep 8, 2025, 06_33_02 PM.png'
    ],
    attack: ['images/ChatGPT Image Sep 2, 2025, 09_04_04 PM-fotor-bg-remover-2025090221451.png'],
    special: ['images/ChatGPT Image Sep 2, 2025, 09_04_04 PM-fotor-bg-remover-2025090221451.png']
  },
  ninjaAzul: {
    idle: ['images/ChatGPT Image Sep 4, 2025, 03_29_16 PM-fotor-bg-remover-2025090415471.png'],
    walk: [
      'images/ChatGPT Image Sep 4, 2025, 03_29_16 PM-fotor-bg-remover-2025090415471.png',
      'images/ChatGPT Image Sep 8, 2025, 06_32_56 PM.png',
      'images/ChatGPT Image Sep 8, 2025, 06_32_59 PM.png',
      'images/ChatGPT Image Sep 8, 2025, 06_33_02 PM.png'
    ],
    attack: ['images/ChatGPT Image Sep 4, 2025, 03_29_16 PM-fotor-bg-remover-2025090415471.png'],
    special: ['images/ChatGPT Image Sep 4, 2025, 03_29_16 PM-fotor-bg-remover-2025090415471.png']
  }
};

// Animation functions
function updateAnimation() {
  const currentTime = Date.now();
  if (currentTime - lastAnimationUpdate > (1000 / animationSpeed)) {
    animationFrame = (animationFrame + 1) % 4; // 4 frames de animaci√≥n
    lastAnimationUpdate = currentTime;
  }
}

function getCurrentSprite(characterId, animationType = 'idle') {
  const character = characterAnimations[characterId];
  if (!character || !character[animationType]) {
    return characterAnimations.kai.idle[0]; // Fallback
  }
  
  const sprites = character[animationType];
  const frameIndex = animationFrame % sprites.length;
  return sprites[frameIndex];
}

function preloadCharacterSprites() {
  // Precargar todas las im√°genes de animaci√≥n
  const allSprites = [];
  Object.values(characterAnimations).forEach(character => {
    Object.values(character).forEach(animation => {
      allSprites.push(...animation);
    });
  });
  
  const uniqueSprites = [...new Set(allSprites)];
  let loadedCount = 0;
  
  uniqueSprites.forEach(spritePath => {
    const img = new Image();
    img.onload = () => {
      loadedCount++;
      console.log(`Loaded sprite: ${spritePath} (${loadedCount}/${uniqueSprites.length})`);
    };
    img.onerror = () => {
      console.error(`Failed to load sprite: ${spritePath}`);
    };
    img.src = spritePath;
  });
}

// Sistema de c√°mara eliminado - Lloyd se mueve libremente sin c√°mara

// Inicializar edificios de la ciudad como desaf√≠os
function initializeCityBuildings() {
  cityBuildings = [
    {
      id: 'dojo_training',
      name: 'üèØ Dojo de Entrenamiento',
      x: 200,
      y: 150,
      width: 120,
      height: 100,
      type: 'training',
      description: 'Entrena tus habilidades b√°sicas',
      reward: 50,
      difficulty: 1,
      enemies: ['kai', 'jay']
    },
    {
      id: 'temple_fire',
      name: 'üî• Templo del Fuego',
      x: 600,
      y: 200,
      width: 120,
      height: 100,
      type: 'elemental',
      description: 'Desaf√≠a a los maestros del fuego',
      reward: 100,
      difficulty: 2,
      enemies: ['kai', 'cole']
    },
    {
      id: 'temple_ice',
      name: '‚ùÑÔ∏è Templo del Hielo',
      x: 300,
      y: 400,
      width: 120,
      height: 100,
      type: 'elemental',
      description: 'Enfrenta a los guerreros del hielo',
      reward: 100,
      difficulty: 2,
      enemies: ['zane', 'jay']
    },
    {
      id: 'temple_earth',
      name: 'üåç Templo de la Tierra',
      x: 500,
      y: 450,
      width: 120,
      height: 100,
      type: 'elemental',
      description: 'Combate contra los guardianes de la tierra',
      reward: 100,
      difficulty: 2,
      enemies: ['cole', 'kai']
    },
    {
      id: 'temple_lightning',
      name: '‚ö° Templo del Rayo',
      x: 150,
      y: 350,
      width: 120,
      height: 100,
      type: 'elemental',
      description: 'Desaf√≠a a los maestros del rayo',
      reward: 100,
      difficulty: 2,
      enemies: ['jay', 'zane']
    },
    {
      id: 'dark_temple',
      name: 'üåë Templo Oscuro',
      x: 400,
      y: 100,
      width: 150,
      height: 120,
      type: 'boss',
      description: 'El desaf√≠o final - Enfrenta al Se√±or Oscuro',
      reward: 500,
      difficulty: 5,
      enemies: ['garmadon'],
      isFinalBoss: true
    }
  ];
  
  console.log("City buildings initialized:", cityBuildings.length);
}

// Verificar edificios cercanos
function checkNearbyBuildings() {
  if (!player1) return;
  
  nearbyBuildings = [];
  const detectionRadius = 80;
  
  cityBuildings.forEach(building => {
    const distance = Math.sqrt(
      Math.pow(player1.x - building.x, 2) + 
      Math.pow(player1.y - building.y, 2)
    );
    
    if (distance <= detectionRadius) {
      nearbyBuildings.push(building);
    }
  });
}

// Entrar a un edificio para el desaf√≠o
function enterBuilding(building) {
  if (!building) return;
  
  console.log("Entering building:", building.name);
  
  // Salir del modo aventura temporalmente
  isAdventureMode = false;
  
  // Configurar el desaf√≠o
  if (building.isFinalBoss) {
    // Boss final
    startBossBattle(building);
  } else {
    // Desaf√≠o normal
    startBuildingChallenge(building);
  }
}

// Iniciar desaf√≠o de edificio
function startBuildingChallenge(building) {
  // Establecer el edificio actual
  currentBuilding = building;
  
  // Seleccionar enemigo aleatorio del edificio
  const randomEnemy = building.enemies[Math.floor(Math.random() * building.enemies.length)];
  
  // Configurar jugadores
  player1 = {
    id: 'lloyd',
    name: 'Lloyd (Green Ninja)',
    x: 200,
    y: 300,
    width: 80,
    height: 100,
    speed: 8,
    health: 100,
    maxHealth: 100,
    facing: 1,
    image: new Image(),
    isAI: false,
    lastAttack: 0,
    lastSpecial: 0,
    attackCooldown: 500,
    specialCooldown: 2000,
    isAttacking: false,
    isSpecialAttacking: false,
    animationFrame: 0
  };
  
  player2 = {
    id: randomEnemy,
    name: characters[randomEnemy].name,
    x: 600,
    y: 300,
    width: 80,
    height: 100,
    speed: 6,
    health: 80 + (building.difficulty * 20),
    maxHealth: 80 + (building.difficulty * 20),
    facing: -1,
    image: new Image(),
    isAI: true,
    lastAttack: 0,
    lastSpecial: 0,
    attackCooldown: 800,
    specialCooldown: 3000,
    isAttacking: false,
    isSpecialAttacking: false,
    animationFrame: 0
  };
  
  // Cargar im√°genes
  player1.image.src = characters['lloyd'].img;
  player2.image.src = characters[randomEnemy].img;
  
  // Mostrar mensaje
  alert(`üèØ ${building.name}\n\n${building.description}\n\nüí∞ Recompensa: ${building.reward} cash\n‚öîÔ∏è Dificultad: ${building.difficulty}/5\n\n¬°Prep√°rate para la batalla!`);
  
  // Iniciar batalla
  gameState = "battle";
  updateUI();
  gameLoop();
}

// Iniciar batalla contra el boss final
function startBossBattle(building) {
  // Establecer el edificio actual
  currentBuilding = building;
  
  // Crear el boss final (Garmadon mejorado)
  player1 = {
    id: 'lloyd',
    name: 'Lloyd (Green Ninja)',
    x: 200,
    y: 300,
    width: 80,
    height: 100,
    speed: 8,
    health: 100,
    maxHealth: 100,
    facing: 1,
    image: new Image(),
    isAI: false,
    lastAttack: 0,
    lastSpecial: 0,
    attackCooldown: 500,
    specialCooldown: 2000,
    isAttacking: false,
    isSpecialAttacking: false,
    animationFrame: 0
  };
  
  player2 = {
    id: 'garmadon_boss',
    name: 'Lord Garmadon (Boss Final)',
    x: 600,
    y: 300,
    width: 100,
    height: 120,
    speed: 7,
    health: 300,
    maxHealth: 300,
    facing: -1,
    image: new Image(),
    isAI: true,
    lastAttack: 0,
    lastSpecial: 0,
    attackCooldown: 600,
    specialCooldown: 2000,
    isAttacking: false,
    isSpecialAttacking: false,
    animationFrame: 0,
    isBoss: true
  };
  
  // Cargar im√°genes
  player1.image.src = characters['lloyd'].img;
  player2.image.src = characters['garmadon'].img;
  
  // Mostrar mensaje √©pico
  alert(`üåë ${building.name}\n\n${building.description}\n\nüí∞ Recompensa: ${building.reward} cash\n‚öîÔ∏è Dificultad: ${building.difficulty}/5\n\nüî• ¬°LA BATALLA FINAL HA COMENZADO! üî•\n\n¬°Demuestra que eres digno de ser el Ninja Verde!`);
  
  // Iniciar batalla
  gameState = "battle";
  updateUI();
  gameLoop();
}

// Regresar al modo aventura despu√©s de completar un desaf√≠o
function returnToAdventureMode() {
  console.log("Returning to adventure mode");
  
  // Limpiar el resultado de la batalla
  const resultDiv = document.getElementById("result");
  resultDiv.style.display = "none";
  
  // Limpiar el bot√≥n de volver al men√∫
  const backButton = document.getElementById("backToMenu");
  backButton.style.display = "none";
  
  // Restaurar Lloyd para el modo aventura
  player1 = {
    id: 'lloyd',
    name: 'Lloyd (Green Ninja)',
    x: playerPosition.x,
    y: playerPosition.y,
    width: 80,
    height: 100,
    speed: 12,
    health: 100,
    maxHealth: 100,
    facing: 1,
    image: new Image(),
    isAI: false,
    lastAttack: 0,
    lastSpecial: 0,
    attackCooldown: 500,
    specialCooldown: 2000,
    isAttacking: false,
    isSpecialAttacking: false,
    animationFrame: 0
  };
  
  // Cargar imagen de Lloyd
  player1.image.src = characters['lloyd'].img;
  
  // Limpiar el oponente
  player2 = null;
  
  // Restaurar modo aventura
  isAdventureMode = true;
  gameState = "battle"; // Para el renderizado
  
  // Mostrar canvas
  canvas.style.display = "block";
  
  // Asegurar foco en el canvas
  canvas.focus();
  
  // Reiniciar el loop del juego
  gameLoop();
}

// Cache de im√°genes para optimizar rendimiento
const imageCache = new Map();

function drawAnimatedCharacter(player, isPlayer1 = true) {
  if (!player) return;
  
  // Determinar el tipo de animaci√≥n basado en el estado del jugador
  let animationType = 'idle';
  
  if (isPlayer1) {
    // Para el jugador 1, verificar si est√° movi√©ndose
    const isMoving = keys['w'] || keys['a'] || keys['s'] || keys['d'] || 
                    keys['arrowup'] || keys['arrowleft'] || keys['arrowdown'] || keys['arrowright'];
    
    if (isMoving) {
      animationType = 'walk';
    } else if (player.isAttacking) {
      animationType = 'attack';
    } else if (player.isSpecialAttacking) {
      animationType = 'special';
    }
  } else {
    // Para el AI, verificar su estado
    if (player.state === 'chase' || player.state === 'retreat') {
      animationType = 'walk';
    } else if (player.state === 'attack') {
      animationType = 'attack';
    }
  }
  
  // Obtener el sprite actual
  const currentSprite = getCurrentSprite(player.id, animationType);
  
  // Verificar si la imagen est√° en cach√©
  let img = imageCache.get(currentSprite);
  
  if (!img) {
    // Crear nueva imagen y agregarla al cach√©
    img = new Image();
    img.onload = () => {
      console.log(`Cached sprite: ${currentSprite}`);
    };
    img.onerror = () => {
      console.error(`Failed to load sprite: ${currentSprite}`);
    };
    img.src = currentSprite;
    imageCache.set(currentSprite, img);
  }
  
  // Dibujar el personaje
  if (img.complete && img.naturalWidth > 0) {
    ctx.save();
    ctx.scale(player.facing, 1);
    const drawX = player.facing === 1 ? player.x : -player.x;
    const size = isPlayer1 ? 80 : 64;
    const height = isPlayer1 ? 100 : 64;
    ctx.drawImage(img, drawX - size/2, player.y - height/2, size, height);
    ctx.restore();
  } else {
    // Fallback si la imagen no est√° lista
    ctx.fillStyle = isPlayer1 ? '#00ff00' : '#0000ff';
    const size = isPlayer1 ? 80 : 50;
    ctx.fillRect(player.x - size/2, player.y - size/2, size, size);
    
    // Dibujar indicador de animaci√≥n
    ctx.fillStyle = '#ffffff';
    ctx.font = '10px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(animationType.toUpperCase(), player.x, player.y - size/2 - 10);
  }
}
let player1 = null;
let player2 = null;
let playerCash = 1000; // Cash inicial del jugador
let playerLevel = 1; // Nivel del jugador (aumenta con victorias)
let aiDifficulty = 1; // Dificultad de la IA (aumenta con victorias)
let currentTournament = null; // Torneo actual
let currentBuilding = null; // Edificio actual (desaf√≠o)
let originalEndBattleWithWinner = null; // Funci√≥n original para restaurar
let isAdventureMode = false; // Si estamos en modo aventura
let playerPosition = { x: 400, y: 300 }; // Posici√≥n central del jugador en modo aventura
let cameraOffset = { x: 0, y: 0 }; // Offset de la c√°mara para seguir al jugador
let nearbyTournaments = []; // Torneos cercanos al jugador
let nearbyBuildings = []; // Edificios cercanos al jugador
let cityBuildings = []; // Todos los edificios de la ciudad
let finalBoss = null; // Boss final del modo aventura

// Variables para modo online
let isOnlineMode = false; // Si estamos en modo online
let socket = null; // Conexi√≥n WebSocket
let currentRoom = null; // Sala actual
let onlinePlayers = new Map(); // Jugadores online
let selectedOnlineCharacter = null; // Personaje seleccionado para online

// Sistema de animaciones (ya implementado arriba)
let lastTime = 0;

// Input handling
const keys = {};
const mouse = { x: 0, y: 0 };

// Character definitions with exact image names (only the 4 from the photo)
// IMPORTANT: Make sure your PNG images have transparent backgrounds for best results!
// The images should be saved as PNG with transparency (not JPG or PNG with white background)
const characters = {
  kai: {
    name: "Kai (Red Ninja)",
            img: "images/ninjarojosinmascara.png.png",
    attack: 25,
    defense: 15,
    special: "Fire Storm",
    specialDamage: 40,
    speed: 5,
    weapon: "Golden Sword",
    maxHealth: 200  // Increased health
  },
  zane: {
    name: "Zane (White Ninja)",
            img: "images/ninjablanco.png-fotor-bg-remover-20250902204741.png",
    attack: 20,
    defense: 20,
    special: "Ice Freeze",
    specialDamage: 35,
    speed: 4,
    weapon: "Ice Staff",
    maxHealth: 180  // Increased health
  },
  jay: {
    name: "Jay (Blue Ninja)",
            img: "images/ninjaazul.png-fotor-bg-remover-20250902204441.png",
    attack: 30,
    defense: 10,
    special: "Lightning Strike",
    specialDamage: 45,
    speed: 6,
    weapon: "Lightning Blade",
    maxHealth: 160  // Increased health
  },
  lloyd: {
    name: "Lloyd (Green Ninja)",
            img: "images/ChatGPT Image Sep 2, 2025, 09_04_04 PM-fotor-bg-remover-2025090221451.png",
    attack: 35,
    defense: 5,
    special: "Energy Blast",
    specialDamage: 50,
    speed: 7,
    weapon: "Energy Katana",
    maxHealth: 250  // Increased health
  },
  ninjaAzul: {
    name: "Ninja Azul (Mujer)",
            img: "images/ChatGPT Image Sep 4, 2025, 03_29_16 PM-fotor-bg-remover-2025090415471.png",
    attack: 28,
    defense: 18,
    special: "Agua Torrencial",
    specialDamage: 42,
    speed: 6,
    weapon: "Tridente de Agua",
    maxHealth: 190,  // Increased health
    price: 1000,     // Precio en cash
    unlocked: false  // No desbloqueado inicialmente
  }
};

// World definitions
const worlds = {
  ice: {
    name: "‚ùÑÔ∏è Ice World",
            background: "images/iceworld.png.png",
    description: "Frozen battleground with crystal spires",
    ambientColor: "#87CEEB",
    particleColor: "#FFFFFF"
  },
  lava: {
    name: "üåã Lava World",
            background: "images/mundolava.png.png",
    description: "Volcanic terrain with flowing lava",
    ambientColor: "#FF4500",
    particleColor: "#FF8C00"
  },
  jungle: {
    name: "üåø Jungle World",
            background: "images/ChatGPT Image Sep 4, 2025, 03_07_48 PM.png",
    description: "Dense jungle with ancient ruins",
    ambientColor: "#228B22",
    particleColor: "#32CD32"
  },
  legoCity: {
    name: "üèôÔ∏è Lego City",
    background: "images/ciudad lego.jpg",
    description: "Vibrant Lego city with tournaments and adventures",
    ambientColor: "#FFD700",
    particleColor: "#FF6B6B",
    isAdventureWorld: true,
    tournaments: [
      {
        id: "beginner_tournament",
        name: "ü•â Torneo Principiante",
        location: { x: 200, y: 300 },
        difficulty: "easy",
        reward: 500,
        description: "Perfecto para nuevos ninjas"
      },
      {
        id: "intermediate_tournament", 
        name: "ü•à Torneo Intermedio",
        location: { x: 600, y: 250 },
        difficulty: "medium",
        reward: 1000,
        description: "Para ninjas con experiencia"
      },
      {
        id: "master_tournament",
        name: "ü•á Torneo Maestro",
        location: { x: 1000, y: 200 },
        difficulty: "hard", 
        reward: 2000,
        description: "Solo para los mejores ninjas"
      },
      {
        id: "championship_tournament",
        name: "üèÜ Campeonato Supremo",
        location: { x: 400, y: 500 },
        difficulty: "extreme",
        reward: 5000,
        description: "El torneo m√°s dif√≠cil de todos"
      }
    ]
  }
};

// Hide canvas until game starts
canvas.style.display = "none";

// Input event listeners
document.addEventListener('keydown', (e) => {
  keys[e.key.toLowerCase()] = true;
  console.log("Key pressed:", e.key.toLowerCase(), "keys object:", keys);
});

document.addEventListener('keyup', (e) => {
  keys[e.key.toLowerCase()] = false;
  console.log("Key released:", e.key.toLowerCase());
});

canvas.addEventListener('mousemove', (e) => {
  const rect = canvas.getBoundingClientRect();
  mouse.x = e.clientX - rect.left;
  mouse.y = e.clientY - rect.top;
});

canvas.addEventListener('click', (e) => {
  const rect = canvas.getBoundingClientRect();
  const clickX = e.clientX - rect.left;
  const clickY = e.clientY - rect.top;
  
  // Bot√≥n de prueba
  if (clickX >= 50 && clickX <= 150 && clickY >= 50 && clickY <= 80) {
    if (player1) {
      player1.x += 50;
      player1.y += 50;
      console.log("TEST MOVE CLICKED! New position:", player1.x, player1.y);
    }
  }
  
  // Bot√≥n de movimiento forzado
  if (clickX >= 50 && clickX <= 150 && clickY >= 90 && clickY <= 120) {
    console.log("FORCE MOVE CLICKED!");
    if (player1) {
      // Simular movimiento con teclas
      keys['d'] = true;
      setTimeout(() => {
        keys['d'] = false;
        console.log("Force movement completed");
      }, 100);
    }
  }
});

function startWorldSelect() {
  console.log("startWorldSelect called");
  console.log("Menu element:", document.getElementById("menu"));
  console.log("WorldSelect element:", document.getElementById("worldSelect"));
  
  document.getElementById("menu").style.display = "none";
  document.getElementById("worldSelect").style.display = "flex";
  gameState = "worldSelect";
  
  console.log("Menu display:", document.getElementById("menu").style.display);
  console.log("WorldSelect display:", document.getElementById("worldSelect").style.display);
  
  // Actualizar cash en el men√∫ principal
  if (document.getElementById("menuCash")) {
    document.getElementById("menuCash").textContent = playerCash;
  }
}

function selectWorld(worldId) {
  selectedWorld = worldId;
  console.log("Selected world:", worldId, "World data:", worlds[worldId]);
  
  // Si se selecciona la ciudad de Lego, iniciar modo aventura directamente
  if (worldId === 'legoCity') {
    startAdventureMode();
    return;
  }
  
  // Para otros mundos, ir a selecci√≥n de personajes
  document.getElementById("worldSelect").style.display = "none";
  document.getElementById("characterSelect").style.display = "flex";
  gameState = "characterSelect";
  
  // Actualizar visibilidad de personajes desbloqueados
  updateCharacterSelectVisibility();
}

function backToWorldSelect() {
  document.getElementById("characterSelect").style.display = "none";
  document.getElementById("worldSelect").style.display = "flex";
  gameState = "worldSelect";
}

function backToMenu() {
  if (gameState === "worldSelect") {
    document.getElementById("worldSelect").style.display = "none";
  } else if (gameState === "characterSelect") {
    document.getElementById("characterSelect").style.display = "none";
  }
  document.getElementById("menu").style.display = "flex";
  gameState = "menu";
  
  // Actualizar cash en el men√∫ principal
  if (document.getElementById("menuCash")) {
    document.getElementById("menuCash").textContent = playerCash;
  }
}

function selectCharacter(characterId) {
  // Verificar si el personaje est√° desbloqueado
  const unlockedCharacters = JSON.parse(localStorage.getItem('unlockedCharacters') || '[]');
  
  // Los 4 personajes principales siempre est√°n disponibles
  const mainCharacters = ['kai', 'zane', 'jay', 'lloyd'];
  const isMainCharacter = mainCharacters.includes(characterId);
  
  if (!isMainCharacter && !unlockedCharacters.includes(characterId)) {
    const character = characters[characterId];
    if (character && character.price) {
      alert(`‚ùå Este personaje no est√° desbloqueado. Necesitas ${character.price} cash para comprarlo.`);
    } else {
      alert(`‚ùå Este personaje no est√° disponible.`);
    }
    return;
  }
  
  selectedCharacter = characterId;
  console.log("Selected character:", characterId);
  console.log("Character data:", characters[characterId]);
  console.log("Image path:", characters[characterId].img);
  console.log("Starting battle with character:", characters[characterId].name);
  startBattle();
}

function startBattle() {
  document.getElementById("characterSelect").style.display = "none";
  canvas.style.display = "block";
  document.getElementById("gameUI").style.display = "block";
  document.getElementById("worldInfo").style.display = "block";
  document.querySelector(".controls").style.display = "block";
  
  gameState = "battle";
  
  // Sistema de cash del jugador
  if (!localStorage.getItem('playerCash')) {
    localStorage.setItem('playerCash', '1000'); // Cash inicial
  }
  playerCash = parseInt(localStorage.getItem('playerCash'));
  
  // Cargar nivel y dificultad del jugador
  if (!localStorage.getItem('playerLevel')) {
    localStorage.setItem('playerLevel', '1');
  }
  playerLevel = parseInt(localStorage.getItem('playerLevel'));
  
  if (!localStorage.getItem('aiDifficulty')) {
    localStorage.setItem('aiDifficulty', '1');
  }
  aiDifficulty = parseInt(localStorage.getItem('aiDifficulty'));
  
  // Verificar personajes desbloqueados
  if (!localStorage.getItem('unlockedCharacters')) {
    localStorage.setItem('unlockedCharacters', JSON.stringify([]));
  }
  const unlockedCharacters = JSON.parse(localStorage.getItem('unlockedCharacters'));
  
  // Actualizar cash en el men√∫ principal
  if (document.getElementById("menuCash")) {
    document.getElementById("menuCash").textContent = playerCash;
  }
  
  // Actualizar nivel y dificultad en el men√∫ principal
  if (document.getElementById("menuLevel")) {
    document.getElementById("menuLevel").textContent = playerLevel;
  }
  if (document.getElementById("menuDifficulty")) {
    document.getElementById("menuDifficulty").textContent = aiDifficulty;
  }
  
  // Update world info
  document.getElementById("worldName").textContent = worlds[selectedWorld].name;
  
  // Create player 1 (human)
  player1 = {
    id: selectedCharacter,
    name: characters[selectedCharacter].name,
    health: characters[selectedCharacter].maxHealth,
    maxHealth: characters[selectedCharacter].maxHealth,
    attack: characters[selectedCharacter].attack,
    defense: characters[selectedCharacter].defense,
    special: characters[selectedCharacter].special,
    specialDamage: characters[selectedCharacter].specialDamage,
    speed: characters[selectedCharacter].speed,
    weapon: characters[selectedCharacter].weapon,
    x: 150,
    y: canvas.height - 200,
    image: new Image(),
    lastAttack: 0,
    lastSpecial: 0,
    isAttacking: false,
    isSpecialAttacking: false,
    attackCooldown: 500,
    specialCooldown: 2000,
    facing: 1, // 1 = right, -1 = left
    animationFrame: 0
  };
  
  // Aplicar habilidades activas del jugador
  applyActiveSkills(player1);
  
  // Load player 1 image with error handling
  console.log("Loading player 1 image from:", characters[selectedCharacter].img);
  player1.image.onload = () => {
    console.log("Player 1 image loaded successfully:", characters[selectedCharacter].img);
  };
  player1.image.onerror = () => {
    console.error("Failed to load player 1 image:", characters[selectedCharacter].img);
    // Create a colored rectangle as fallback
    player1.image = null;
    player1.color = '#ff0000';
  };
  player1.image.src = characters[selectedCharacter].img;
  
  // Create player 2 (AI) - choose from remaining characters
  const availableCharacters = Object.keys(characters).filter(id => id !== selectedCharacter);
  const aiCharacterId = availableCharacters[Math.floor(Math.random() * availableCharacters.length)];
  
  player2 = {
    id: aiCharacterId,
    name: characters[aiCharacterId].name,
    health: characters[aiCharacterId].maxHealth,
    maxHealth: characters[aiCharacterId].maxHealth,
    attack: characters[aiCharacterId].attack,
    defense: characters[aiCharacterId].defense,
    special: characters[aiCharacterId].special,
    specialDamage: characters[aiCharacterId].specialDamage,
    speed: characters[aiCharacterId].speed,
    weapon: characters[aiCharacterId].weapon,
    x: canvas.width - 150,
    y: canvas.height - 200,
    image: new Image(),
    isAI: true,
    lastAttack: 0,
    lastSpecial: 0,
    target: player1,
    state: 'chase',
    facing: -1,
    animationFrame: 0
  };
  
  // Load player 2 image with error handling
  console.log("Loading player 2 image from:", characters[aiCharacterId].img);
  player2.image.onload = () => {
    console.log("Player 2 image loaded successfully:", characters[aiCharacterId].img);
  };
  player2.image.onerror = () => {
    console.error("Failed to load player 2 image:", characters[aiCharacterId].img);
    // Create a colored rectangle as fallback
    player2.image = null;
    player2.color = '#0000ff';
  };
  player2.image.src = characters[aiCharacterId].img;
  
  // Update UI
  updateUI();
  
  // Debug: Log final player setup
  console.log("Battle started! Player1:", player1.name, "Player2:", player2.name);
  console.log("Player1 position:", player1.x, player1.y, "Player2 position:", player2.x, player2.y);
  console.log("Controls: WASD/Arrow keys to move, Ctrl to attack, Enter for special");
  
  // Start game loop
  gameLoop();
}

function updateUI() {
  document.getElementById("player1Name").textContent = player1.name;
  document.getElementById("player2Name").textContent = player2.name;
  
  const player1HealthPercent = (player1.health / player1.maxHealth) * 100;
  const player2HealthPercent = (player2.health / player2.maxHealth) * 100;
  
  document.getElementById("player1Health").style.width = player1HealthPercent + "%";
  document.getElementById("player2Health").style.width = player2HealthPercent + "%";
}

function handlePlayerInput() {
  if (!player1) {
    console.log("handlePlayerInput: player1 is null");
    return;
  }
  
  // Log de estado cada frame para debug
  if (Math.random() < 0.1) { // 10% de las veces
    console.log("handlePlayerInput: player1 exists, keys:", keys);
    console.log("isAdventureMode:", isAdventureMode);
    console.log("player1 position:", player1.x, player1.y);
    console.log("player1 speed:", player1.speed);
  }
  
  let isMoving = false;
  let oldX = player1.x;
  let oldY = player1.y;
  
  // Movement - exactamente como en las batallas
  if (keys['w'] || keys['arrowup']) {
    player1.y -= player1.speed;
    isMoving = true;
    console.log("üéÆ LLOYD MOVING UP! From", oldX, oldY, "to", player1.x, player1.y);
  }
  if (keys['s'] || keys['arrowdown']) {
    player1.y += player1.speed;
    isMoving = true;
    console.log("üéÆ LLOYD MOVING DOWN! From", oldX, oldY, "to", player1.x, player1.y);
  }
  if (keys['a'] || keys['arrowleft']) {
    player1.x -= player1.speed;
    player1.facing = -1;
    isMoving = true;
    console.log("üéÆ LLOYD MOVING LEFT! From", oldX, oldY, "to", player1.x, player1.y);
  }
  if (keys['d'] || keys['arrowright']) {
    player1.x += player1.speed;
    player1.facing = 1;
    isMoving = true;
    console.log("üéÆ LLOYD MOVING RIGHT! From", oldX, oldY, "to", player1.x, player1.y);
  }
  
  if (isMoving) {
    console.log("‚úÖ LLOYD IS MOVING! Position:", player1.x, player1.y, "Speed:", player1.speed);
  }
  
  // Movement logic - simplificado para todos los modos
  if (isAdventureMode) {
    // En modo aventura, permitir movimiento libre por toda la ciudad
    // L√≠mites m√°s amplios para explorar toda la ciudad
    player1.x = Math.max(40, Math.min(canvas.width - 40, player1.x));
    player1.y = Math.max(40, Math.min(canvas.height - 40, player1.y));
    
    // Actualizar posici√≥n del jugador
    playerPosition.x = player1.x;
    playerPosition.y = player1.y;
    
    // Sistema de c√°mara eliminado - Lloyd se mueve libremente sin c√°mara
    
    // Verificar torneos cercanos
    checkNearbyTournaments();
    
    // Verificar edificios cercanos
    checkNearbyBuildings();
    
    // Interactuar con torneos o edificios con Enter
    if (keys['enter']) {
      if (nearbyTournaments.length > 0) {
        const tournament = nearbyTournaments[0];
        enterTournamentFromAdventure(tournament);
      } else if (nearbyBuildings.length > 0) {
        const building = nearbyBuildings[0];
        enterBuilding(building);
      }
    }
    
    // Volver al men√∫ con Escape
    if (keys['escape']) {
      exitAdventureMode();
    }
  } else {
    // En modo batalla normal, mantener l√≠mites estrictos
    player1.x = Math.max(100, Math.min(canvas.width - 100, player1.x));
    player1.y = Math.max(100, Math.min(canvas.height - 100, player1.y));
    
    // Attack with Ctrl
    if (keys['control'] && Date.now() - player1.lastAttack > player1.attackCooldown) {
      attack(player1, player2);
      player1.lastAttack = Date.now();
      player1.isAttacking = true;
      setTimeout(() => { 
        player1.isAttacking = false; 
      }, 200);
    }
    
    // Special attack with Enter
    if (keys['enter'] && Date.now() - player1.lastSpecial > player1.specialCooldown) {
      specialAttack(player1, player2);
      player1.lastSpecial = Date.now();
      player1.isSpecialAttacking = true;
      setTimeout(() => { 
        player1.isSpecialAttacking = false; 
      }, 500);
    }
  }
}

function updateAI() {
  if (!player2 || !player2.target) return;
  
  const target = player2.target;
  const dx = target.x - player2.x;
  const dy = target.y - player2.y;
  const distance = Math.sqrt(dx * dx + dy * dy);
  
  // AI behavior con dificultad progresiva
  const difficultyMultiplier = 0.5 + (aiDifficulty * 0.1); // 0.6 a 1.5
  
  if (distance > 200) {
    // Chase player
    player2.state = 'chase';
    const oldX = player2.x;
    const oldY = player2.y;
    player2.x += (dx / distance) * player2.speed * 0.6 * difficultyMultiplier;
    player2.y += (dy / distance) * player2.speed * 0.6 * difficultyMultiplier;
    player2.facing = dx > 0 ? 1 : -1;
    console.log("AI chasing (difficulty:", aiDifficulty, "), moved from", oldX, oldY, "to", player2.x, player2.y);
    // AI movement (sin animaci√≥n)
  } else if (distance < 80) {
    // Too close, retreat
    player2.state = 'retreat';
    const oldX = player2.x;
    const oldY = player2.y;
    player2.x -= (dx / distance) * player2.speed * 0.4 * difficultyMultiplier;
    player2.y -= (dy / distance) * player2.speed * 0.4 * difficultyMultiplier;
    player2.facing = dx > 0 ? -1 : 1;
    console.log("AI retreating (difficulty:", aiDifficulty, "), moved from", oldX, oldY, "to", player2.x, player2.y);
    // AI retreat logic (sin animaci√≥n)
  } else {
    // Attack range - Solo atacar si el jugador est√° atacando o despu√©s de un delay
    player2.state = 'attack';
    
    // Solo atacar si el jugador ha atacado recientemente o despu√©s de un delay m√°s largo
    const timeSincePlayerAttack = Date.now() - (player1.lastAttack || 0);
    const shouldAttack = timeSincePlayerAttack < 2000 || Date.now() - player2.lastAttack > 3000; // 3 segundos de delay
    
    // Cooldowns m√°s r√°pidos con mayor dificultad
    const attackCooldown = Math.max(500, 1500 - (aiDifficulty * 100));
    const specialCooldown = Math.max(2000, 5000 - (aiDifficulty * 300));
    
    if (shouldAttack && Date.now() - player2.lastAttack > attackCooldown) {
      attack(player2, target);
      player2.lastAttack = Date.now();
      console.log("AI attacking player - player last attack was", timeSincePlayerAttack, "ms ago");
    }
    if (shouldAttack && Date.now() - player2.lastSpecial > specialCooldown) {
      specialAttack(player2, target);
      player2.lastSpecial = Date.now();
      console.log("AI special attacking player - player last attack was", timeSincePlayerAttack, "ms ago");
    }
  }
  
  // Keep AI on screen
  player2.x = Math.max(100, Math.min(canvas.width - 100, player2.x));
  player2.y = Math.max(100, Math.min(canvas.height - 100, player2.y));
}

function attack(attacker, target) {
  const damage = Math.floor(attacker.attack * (0.8 + Math.random() * 0.4));
  target.health -= damage;
  
  if (target.health <= 0) {
    target.health = 0;
    endBattleWithWinner(attacker.name);
    return;
  }
  
  // Hurt effect (sin animaci√≥n)
  // Target takes damage
  
  // Create attack effect
  createAttackEffect(attacker.x, attacker.y, target.x, target.y);
}

function specialAttack(attacker, target) {
  const damage = Math.floor(attacker.specialDamage * (0.9 + Math.random() * 0.2));
  target.health -= damage;
  
  if (target.health <= 0) {
    target.health = 0;
    endBattleWithWinner(attacker.name);
    return;
  }
  
  // Hurt effect (sin animaci√≥n)
  // Target takes damage
  
  // Special effect logic (sin animaci√≥n)
  // Character uses special attack
  
  // Create special attack effect
  createSpecialEffect(attacker.x, attacker.y, target.x, target.y, attacker.special);
}

function createAttackEffect(ax, ay, tx, ty) {
  // World-specific attack effects
  const world = worlds[selectedWorld];
  
  if (selectedWorld === 'ice') {
    // Ice attack effect
    ctx.strokeStyle = '#87CEEB';
    ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.moveTo(ax, ay);
    ctx.lineTo(tx, ty);
    ctx.stroke();
    
    // Ice crystals
    ctx.fillStyle = '#FFFFFF';
    for (let i = 0; i < 3; i++) {
      const x = ax + (tx - ax) * (i + 1) / 4;
      const y = ay + (ty - ay) * (i + 1) / 4;
      ctx.beginPath();
      ctx.moveTo(x, y - 5);
      ctx.lineTo(x + 3, y);
      ctx.lineTo(x, y + 5);
      ctx.lineTo(x - 3, y);
      ctx.closePath();
      ctx.fill();
    }
  } else if (selectedWorld === 'lava') {
    // Lava attack effect - like the sword strike from the image
    ctx.strokeStyle = '#FF4500';
    ctx.lineWidth = 6;
    ctx.beginPath();
    ctx.moveTo(ax, ay);
    ctx.lineTo(tx, ty);
    ctx.stroke();
    
    // Lava particles
    ctx.fillStyle = '#FF8C00';
    for (let i = 0; i < 8; i++) {
      const x = ax + (tx - ax) * (i + 1) / 9;
      const y = ay + (ty - ay) * (i + 1) / 9;
      ctx.beginPath();
      ctx.arc(x, y, 4, 0, Math.PI * 2);
      ctx.fill();
    }
    
    // Sword trail effect
    ctx.strokeStyle = '#FFD700';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(ax, ay);
    ctx.lineTo(tx, ty);
    ctx.stroke();
  } else if (selectedWorld === 'jungle') {
    // Jungle attack effect - nature's fury
    ctx.strokeStyle = '#228B22';
    ctx.lineWidth = 5;
    ctx.beginPath();
    ctx.moveTo(ax, ay);
    ctx.lineTo(tx, ty);
    ctx.stroke();
    
    // Jungle leaves
    ctx.fillStyle = '#32CD32';
    for (let i = 0; i < 6; i++) {
      const x = ax + (tx - ax) * (i + 1) / 7;
      const y = ay + (ty - ay) * (i + 1) / 7;
      ctx.beginPath();
      ctx.moveTo(x, y - 4);
      ctx.lineTo(x + 2, y);
      ctx.lineTo(x, y + 4);
      ctx.lineTo(x - 2, y);
      ctx.closePath();
      ctx.fill();
    }
    
    // Nature trail effect
    ctx.strokeStyle = '#90EE90';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(ax, ay);
    ctx.lineTo(tx, ty);
    ctx.stroke();
  }
}

function createSpecialEffect(ax, ay, tx, ty, specialName) {
  const world = worlds[selectedWorld];
  
  if (selectedWorld === 'ice') {
    // Ice special effect
    ctx.fillStyle = '#87CEEB';
    ctx.font = '18px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(specialName, tx, ty - 30);
    
    // Ice explosion
    ctx.fillStyle = '#FFFFFF';
    ctx.beginPath();
    ctx.arc(tx, ty, 25, 0, Math.PI * 2);
    ctx.fill();
    
    // Ice spikes
    for (let i = 0; i < 8; i++) {
      const angle = (i / 8) * Math.PI * 2;
      const x = tx + Math.cos(angle) * 35;
      const y = ty + Math.sin(angle) * 35;
      ctx.beginPath();
      ctx.moveTo(x, y);
      ctx.lineTo(x + Math.cos(angle) * 10, y + Math.sin(angle) * 10);
      ctx.strokeStyle = '#87CEEB';
      ctx.lineWidth = 3;
      ctx.stroke();
    }
  } else if (selectedWorld === 'lava') {
    // Lava special effect - volcanic eruption style
    ctx.fillStyle = '#FF4500';
    ctx.font = '18px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(specialName, tx, ty - 30);
    
    // Lava explosion
    ctx.fillStyle = '#FF8C00';
    ctx.beginPath();
    ctx.arc(tx, ty, 25, 0, Math.PI * 2);
    ctx.fill();
    
    // Lava waves
    for (let i = 0; i < 3; i++) {
      ctx.strokeStyle = '#FF4500';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.arc(tx, ty, 30 + i * 15, 0, Math.PI * 2);
      ctx.stroke();
    }
    
    // Volcanic particles
    ctx.fillStyle = '#FFD700';
    for (let i = 0; i < 12; i++) {
      const angle = (i / 12) * Math.PI * 2;
      const x = tx + Math.cos(angle) * 40;
      const y = ty + Math.sin(angle) * 40;
      ctx.beginPath();
      ctx.arc(x, y, 3, 0, Math.PI * 2);
      ctx.fill();
    }
  } else if (selectedWorld === 'jungle') {
    // Jungle special effect - nature's wrath
    ctx.fillStyle = '#228B22';
    ctx.font = '18px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(specialName, tx, ty - 30);
    
    // Jungle explosion
    ctx.fillStyle = '#32CD32';
    ctx.beginPath();
    ctx.arc(tx, ty, 25, 0, Math.PI * 2);
    ctx.fill();
    
    // Jungle vines
    for (let i = 0; i < 8; i++) {
      const angle = (i / 8) * Math.PI * 2;
      const x = tx + Math.cos(angle) * 35;
      const y = ty + Math.sin(angle) * 35;
      ctx.beginPath();
      ctx.moveTo(x, y);
      ctx.lineTo(x + Math.cos(angle) * 12, y + Math.sin(angle) * 12);
      ctx.strokeStyle = '#228B22';
      ctx.lineWidth = 4;
      ctx.stroke();
    }
    
    // Nature particles
    ctx.fillStyle = '#90EE90';
    for (let i = 0; i < 15; i++) {
      const angle = (i / 15) * Math.PI * 2;
      const x = tx + Math.cos(angle) * 45;
      const y = ty + Math.sin(angle) * 45;
      ctx.beginPath();
      ctx.arc(x, y, 2, 0, Math.PI * 2);
      ctx.fill();
    }
    
    // Jungle leaves burst
    ctx.fillStyle = '#228B22';
    for (let i = 0; i < 10; i++) {
      const angle = (i / 10) * Math.PI * 2;
      const x = tx + Math.cos(angle) * 50;
      const y = ty + Math.sin(angle) * 50;
      ctx.beginPath();
      ctx.moveTo(x, y - 3);
      ctx.lineTo(x + 2, y);
      ctx.lineTo(x, y + 3);
      ctx.lineTo(x - 2, y);
      ctx.closePath();
      ctx.fill();
    }
  }
}

function endBattleWithWinner(winnerName) {
  // Dar cash al ganador (solo si es el jugador humano)
  if (winnerName === player1.name) {
    let cashGained = 100;
    let levelGained = 1;
    
    // Si es un torneo, dar recompensa especial
    if (currentTournament) {
      cashGained = currentTournament.reward;
      levelGained = Math.floor(cashGained / 500); // 1 nivel por cada 500 cash
      alert(`üèÜ ¬°${winnerName} ha ganado el ${currentTournament.name}! üí∞ +${cashGained} cash (Total: ${playerCash + cashGained}) üÜô +${levelGained} nivel(es)`);
      currentTournament = null; // Limpiar torneo actual
    } else if (currentBuilding) {
      // Si es un desaf√≠o de edificio, dar recompensa espec√≠fica
      cashGained = currentBuilding.reward;
      levelGained = Math.floor(cashGained / 200); // 1 nivel por cada 200 cash
      alert(`üèØ ¬°${winnerName} ha completado ${currentBuilding.name}! üí∞ +${cashGained} cash (Total: ${playerCash + cashGained}) üÜô +${levelGained} nivel(es)`);
      currentBuilding = null; // Limpiar edificio actual
    } else {
      alert(`üèÜ ¬°${winnerName} ha ganado la batalla en ${worlds[selectedWorld].name}! üí∞ +${cashGained} cash (Total: ${playerCash + cashGained}) üÜô Nivel ${playerLevel + levelGained}`);
    }
    
    playerCash += cashGained;
    playerLevel += levelGained;
    aiDifficulty = Math.min(10, Math.floor(playerLevel / 3) + 1); // Dificultad aumenta cada 3 niveles
    
    localStorage.setItem('playerCash', playerCash.toString());
    localStorage.setItem('playerLevel', playerLevel.toString());
    localStorage.setItem('aiDifficulty', aiDifficulty.toString());
  } else {
    if (currentTournament) {
      alert(`üèÜ ${winnerName} ha ganado el ${currentTournament.name}! Mejor suerte la pr√≥xima vez.`);
      currentTournament = null;
    } else {
      alert(`üèÜ ${winnerName} ha ganado la batalla en ${worlds[selectedWorld].name}!`);
    }
  }
  endBattle();
}

function endBattle() {
  // Si estamos en modo aventura, volver al modo aventura despu√©s del torneo
  if (isAdventureMode || currentBuilding) {
    // Volver al modo aventura
    player2 = null; // Solo limpiar el oponente
    gameState = "battle"; // Mantener el estado de batalla para el renderizado
    return; // No cambiar la interfaz
  }
  
  // Si no es modo aventura, volver al men√∫ normal
  gameState = "menu";
  canvas.style.display = "none";
  document.getElementById("gameUI").style.display = "none";
  document.getElementById("worldInfo").style.display = "none";
  document.querySelector(".controls").style.display = "none";
  document.getElementById("menu").style.display = "flex";
  
  // Reset game state
  player1 = null;
  player2 = null;
  selectedCharacter = null;
  selectedWorld = null;
  isAdventureMode = false;
  
  // Actualizar cash en el men√∫ principal
  if (document.getElementById("menuCash")) {
    document.getElementById("menuCash").textContent = playerCash;
  }
}

function gameLoop() {
  // Permitir que el gameLoop funcione en modo aventura y batalla
  if (gameState !== "battle" && !isAdventureMode) {
    console.log("Game loop stopped: gameState =", gameState, "isAdventureMode =", isAdventureMode);
    return;
  }
  
  // Debug: Log game loop execution (solo cada 60 frames para no saturar)
  if (Math.random() < 0.016) { // ~1 vez por segundo
    console.log("Game loop running, gameState:", gameState, "isAdventureMode:", isAdventureMode, "player1:", player1 ? `${player1.name} at ${player1.x},${player1.y}` : "null");
  }
  
  // Usar el mismo sistema de movimiento para todos los modos
  handlePlayerInput();
  
  updateAI();
  render();
  requestAnimationFrame(gameLoop);
}

function render() {
  // Debug: Log render function call
  console.log("Render function called, gameState:", gameState, "player1:", !!player1, "player2:", !!player2);
  
  // Update animations
  updateAnimation();
  
  // Clear canvas
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  // Draw world background
  const world = worlds[selectedWorld];
  if (world && world.background) {
    const background = new Image();
    background.src = world.background;
    
    // Dibujar fondo inmediatamente si est√° cargado, o usar un color de fondo
    if (background.complete) {
      ctx.drawImage(background, 0, 0, canvas.width, canvas.height);
    } else {
      // Fondo de respaldo mientras se carga la imagen
      if (selectedWorld === 'legoCity') {
        ctx.fillStyle = '#4A90E2'; // Azul cielo para la ciudad
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      } else {
        ctx.fillStyle = '#333'; // Fondo oscuro por defecto
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }
      
      // Intentar cargar la imagen
      background.onload = function() {
        ctx.drawImage(background, 0, 0, canvas.width, canvas.height);
      };
    }
    
    // Add world-specific ambient effects
    if (selectedWorld === 'ice') {
      // Ice world ambient effect
      ctx.fillStyle = 'rgba(135, 206, 235, 0.1)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Snow particles
      ctx.fillStyle = '#FFFFFF';
      for (let i = 0; i < 20; i++) {
        const x = (Date.now() / 10 + i * 50) % canvas.width;
        const y = (Date.now() / 5 + i * 30) % canvas.height;
        ctx.beginPath();
        ctx.arc(x, y, 1, 0, Math.PI * 2);
        ctx.fill();
      }
    } else if (selectedWorld === 'lava') {
      // Lava world ambient effect - volcanic atmosphere
      ctx.fillStyle = 'rgba(255, 69, 0, 0.15)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Lava particles and volcanic ash
      ctx.fillStyle = '#FF8C00';
      for (let i = 0; i < 25; i++) {
        const x = (Date.now() / 8 + i * 60) % canvas.width;
        const y = (Date.now() / 6 + i * 40) % canvas.height;
        ctx.beginPath();
        ctx.arc(x, y, 2, 0, Math.PI * 2);
        ctx.fill();
      }
      
      // Volcanic smoke effect
      ctx.fillStyle = 'rgba(64, 64, 64, 0.3)';
      for (let i = 0; i < 8; i++) {
        const x = (Date.now() / 15 + i * 200) % canvas.width;
        const y = 50 + Math.sin(Date.now() / 1000 + i) * 20;
        ctx.beginPath();
        ctx.arc(x, y, 30 + Math.sin(Date.now() / 500 + i) * 10, 0, Math.PI * 2);
        ctx.fill();
      }
    } else if (selectedWorld === 'jungle') {
      // Jungle world ambient effect - lush green atmosphere
      ctx.fillStyle = 'rgba(34, 139, 34, 0.1)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Jungle leaves and particles
      ctx.fillStyle = '#32CD32';
      for (let i = 0; i < 30; i++) {
        const x = (Date.now() / 12 + i * 40) % canvas.width;
        const y = (Date.now() / 8 + i * 25) % canvas.height;
        ctx.beginPath();
        ctx.arc(x, y, 1.5, 0, Math.PI * 2);
        ctx.fill();
      }
      
      // Jungle mist effect
      ctx.fillStyle = 'rgba(50, 205, 50, 0.2)';
      for (let i = 0; i < 6; i++) {
        const x = (Date.now() / 20 + i * 300) % canvas.width;
        const y = 30 + Math.sin(Date.now() / 1500 + i) * 15;
        ctx.beginPath();
        ctx.arc(x, y, 40 + Math.sin(Date.now() / 800 + i) * 15, 0, Math.PI * 2);
        ctx.fill();
      }
    } else if (selectedWorld === 'legoCity') {
      // Lego City ambient effect - vibrant city atmosphere
      ctx.fillStyle = 'rgba(255, 215, 0, 0.1)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // City sparkles and lights
      ctx.fillStyle = '#FF6B6B';
      for (let i = 0; i < 40; i++) {
        const x = (Date.now() / 8 + i * 30) % canvas.width;
        const y = (Date.now() / 6 + i * 20) % canvas.height;
        ctx.beginPath();
        ctx.arc(x, y, 1, 0, Math.PI * 2);
        ctx.fill();
      }
      
      // City glow effect
      ctx.fillStyle = 'rgba(255, 215, 0, 0.15)';
      for (let i = 0; i < 8; i++) {
        const x = (Date.now() / 25 + i * 200) % canvas.width;
        const y = 20 + Math.sin(Date.now() / 2000 + i) * 10;
        ctx.beginPath();
        ctx.arc(x, y, 50 + Math.sin(Date.now() / 1000 + i) * 20, 0, Math.PI * 2);
        ctx.fill();
      }
    }
  }
  
  // Draw battle platform (like the courtyard in the image)
  if (selectedWorld === 'lava') {
    // Lava world platform - transparent so characters appear on the world background
    ctx.fillStyle = 'rgba(139, 69, 19, 0.3)';
    ctx.fillRect(50, canvas.height - 150, canvas.width - 100, 100);
    
    // Subtle platform border
    ctx.strokeStyle = 'rgba(101, 67, 33, 0.5)';
    ctx.lineWidth = 2;
    ctx.strokeRect(50, canvas.height - 150, canvas.width - 100, 100);
    
    // Subtle lava cracks on platform
    ctx.strokeStyle = 'rgba(255, 69, 0, 0.4)';
    ctx.lineWidth = 1;
    for (let i = 0; i < 5; i++) {
      const x = 100 + i * 150;
      ctx.beginPath();
      ctx.moveTo(x, canvas.height - 150);
      ctx.lineTo(x + 50, canvas.height - 100);
      ctx.lineTo(x + 100, canvas.height - 150);
      ctx.stroke();
    }
  } else if (selectedWorld === 'ice') {
    // Ice world platform - very subtle ice platform
    ctx.fillStyle = 'rgba(135, 206, 235, 0.2)';
    ctx.fillRect(50, canvas.height - 150, canvas.width - 100, 100);
    
    // Subtle ice platform border
    ctx.strokeStyle = 'rgba(70, 130, 180, 0.4)';
    ctx.lineWidth = 1;
    ctx.strokeRect(50, canvas.height - 150, canvas.width - 100, 100);
    
    // Subtle ice crystals on platform
    ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
    ctx.lineWidth = 1;
    for (let i = 0; i < 6; i++) {
      const x = 80 + i * 120;
      ctx.beginPath();
      ctx.moveTo(x, canvas.height - 150);
      ctx.lineTo(x + 20, canvas.height - 130);
      ctx.lineTo(x + 40, canvas.height - 150);
      ctx.stroke();
    }
  } else if (selectedWorld === 'jungle') {
    // Jungle world platform - ancient stone platform
    ctx.fillStyle = 'rgba(139, 115, 85, 0.4)';
    ctx.fillRect(50, canvas.height - 150, canvas.width - 100, 100);
    
    // Stone platform border
    ctx.strokeStyle = 'rgba(101, 67, 33, 0.6)';
    ctx.lineWidth = 2;
    ctx.strokeRect(50, canvas.height - 150, canvas.width - 100, 100);
    
    // Jungle vines and moss on platform
    ctx.strokeStyle = 'rgba(34, 139, 34, 0.5)';
    ctx.lineWidth = 2;
    for (let i = 0; i < 4; i++) {
      const x = 120 + i * 180;
      ctx.beginPath();
      ctx.moveTo(x, canvas.height - 150);
      ctx.lineTo(x + 30, canvas.height - 120);
      ctx.lineTo(x + 60, canvas.height - 150);
      ctx.stroke();
    }
    
    // Ancient stone patterns
    ctx.strokeStyle = 'rgba(160, 82, 45, 0.4)';
    ctx.lineWidth = 1;
    for (let i = 0; i < 3; i++) {
      const x = 100 + i * 200;
      ctx.beginPath();
      ctx.moveTo(x, canvas.height - 130);
      ctx.lineTo(x + 100, canvas.height - 130);
      ctx.stroke();
    }
  }
  
  // Draw players with animations
  if (player1) {
    // Draw player 1 with animation
    drawAnimatedCharacter(player1, true);
    
    // Draw weapon
    if (player1.weapon) {
      ctx.fillStyle = '#FFD700';
      ctx.font = '12px Arial';
      ctx.textAlign = 'center';
      ctx.fillText(player1.weapon, player1.x, player1.y + 60);
    }
  }
  
  if (player2) {
    // Draw player 2 with animation
    drawAnimatedCharacter(player2, false);
    
    // Draw weapon
    if (player2.weapon) {
      ctx.fillStyle = '#FFD700';
      ctx.font = '12px Arial';
      ctx.textAlign = 'center';
      ctx.fillText(player2.weapon, player2.x, player2.y + 60);
    }
    
    // Draw AI state indicator
    ctx.fillStyle = player2.state === 'chase' ? '#00ff00' : 
                   player2.state === 'attack' ? '#ff0000' : '#ffff00';
    ctx.font = '12px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(player2.state.toUpperCase(), player2.x, player2.y - 40);
  }
  
      // Draw buildings and tournaments in adventure mode
    if (isAdventureMode && selectedWorld === 'legoCity') {
      // Draw buildings first
      drawCityBuildings();
      
      // Then draw tournaments
      if (worlds[selectedWorld].tournaments) {
        const tournaments = worlds[selectedWorld].tournaments;
        
        tournaments.forEach(tournament => {
          const x = tournament.location.x;
          const y = tournament.location.y;
          
          // Draw tournament marker
          ctx.save();
          
          // Tournament glow effect
          const glowIntensity = 0.3 + 0.2 * Math.sin(Date.now() / 1000);
          ctx.fillStyle = `rgba(255, 215, 0, ${glowIntensity})`;
          ctx.beginPath();
          ctx.arc(x, y, 60, 0, Math.PI * 2);
          ctx.fill();
          
          // Tournament icon based on difficulty
          let icon = 'üèÜ';
          let color = '#FFD700';
          switch(tournament.difficulty) {
            case 'easy':
              icon = 'ü•â';
              color = '#4CAF50';
              break;
            case 'medium':
              icon = 'ü•à';
              color = '#FF9800';
              break;
            case 'hard':
              icon = 'ü•á';
              color = '#F44336';
              break;
            case 'extreme':
              icon = 'üèÜ';
              color = '#9C27B0';
              break;
          }
          
          // Draw tournament icon
          ctx.fillStyle = color;
          ctx.font = '30px Arial';
          ctx.textAlign = 'center';
          ctx.fillText(icon, x, y + 10);
          
          // Draw tournament name
          ctx.fillStyle = 'white';
          ctx.font = 'bold 12px Arial';
          ctx.fillText(tournament.name, x, y + 50);
          
          // Draw reward
          ctx.fillStyle = '#00FF00';
          ctx.font = '10px Arial';
          ctx.fillText(`üí∞ ${tournament.reward}`, x, y + 65);
          
          ctx.restore();
        });
      }
    
    // Draw interaction prompt for nearby tournaments
    if (nearbyTournaments.length > 0) {
      const tournament = nearbyTournaments[0];
      ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
      ctx.fillRect(10, canvas.height - 80, 300, 70);
      
      ctx.fillStyle = '#FFD700';
      ctx.font = 'bold 14px Arial';
      ctx.textAlign = 'left';
      ctx.fillText('üèÜ Torneo Cercano!', 20, canvas.height - 60);
      
      ctx.fillStyle = 'white';
      ctx.font = '12px Arial';
      ctx.fillText(tournament.name, 20, canvas.height - 45);
      ctx.fillText(`Recompensa: üí∞ ${tournament.reward} cash`, 20, canvas.height - 30);
      ctx.fillText('Presiona ENTER para participar', 20, canvas.height - 15);
    }
    
    // Dibujar edificios de la ciudad
    cityBuildings.forEach(building => {
      // Dibujar edificio
      ctx.fillStyle = building.isFinalBoss ? 'rgba(100, 0, 100, 0.8)' : 'rgba(50, 50, 50, 0.8)';
      ctx.fillRect(building.x - building.width/2, building.y - building.height/2, building.width, building.height);
      
      // Borde del edificio
      ctx.strokeStyle = building.isFinalBoss ? '#ff00ff' : '#666';
      ctx.lineWidth = 3;
      ctx.strokeRect(building.x - building.width/2, building.y - building.height/2, building.width, building.height);
      
      // Nombre del edificio
      ctx.fillStyle = 'white';
      ctx.font = 'bold 12px Arial';
      ctx.textAlign = 'center';
      ctx.fillText(building.name, building.x, building.y - building.height/2 - 10);
      
      // Indicador de dificultad
      ctx.fillStyle = building.isFinalBoss ? '#ff00ff' : '#ffaa00';
      ctx.font = 'bold 10px Arial';
      ctx.fillText(`Dificultad: ${building.difficulty}/5`, building.x, building.y + building.height/2 + 15);
    });
    
    // Draw adventure mode controls
    ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
    ctx.fillRect(canvas.width - 220, 10, 210, 160);
    
    ctx.fillStyle = '#00ff00';
    ctx.font = 'bold 14px Arial';
    ctx.textAlign = 'left';
    ctx.fillText('üèôÔ∏è MODO AVENTURA', canvas.width - 210, 30);
    
    ctx.fillStyle = 'white';
    ctx.font = 'bold 12px Arial';
    ctx.fillText('üéÆ Controles:', canvas.width - 210, 50);
    ctx.fillText('WASD - Explorar ciudad', canvas.width - 210, 65);
    ctx.fillText('ENTER - Interactuar', canvas.width - 210, 80);
    ctx.fillText('ESC - Salir', canvas.width - 210, 95);
    
    ctx.fillStyle = '#FFD700';
    ctx.fillText(`üí∞ Cash: ${playerCash}`, canvas.width - 210, 115);
    ctx.fillText('ü•∑ Lloyd (Ninja Verde)', canvas.width - 210, 130);
    ctx.fillText(`üìç Pos: ${Math.round(player1.x)}, ${Math.round(player1.y)}`, canvas.width - 210, 145);
    
    // Mostrar edificio cercano
    if (nearbyBuildings.length > 0) {
      const building = nearbyBuildings[0];
      ctx.fillText(`üè¢ Near: ${building.name}`, canvas.width - 210, 160);
    }
    
    // Draw interaction prompt for nearby buildings
    if (nearbyBuildings.length > 0) {
      const building = nearbyBuildings[0];
      ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
      ctx.fillRect(10, canvas.height - 100, 400, 90);
      
      ctx.fillStyle = '#FFD700';
      ctx.font = 'bold 14px Arial';
      ctx.textAlign = 'left';
      ctx.fillText('üè¢ Edificio Cercano!', 20, canvas.height - 80);
      
      ctx.fillStyle = 'white';
      ctx.font = '12px Arial';
      ctx.fillText(building.name, 20, canvas.height - 65);
      ctx.fillText(building.description, 20, canvas.height - 50);
      ctx.fillText(`üí∞ Recompensa: ${building.reward} cash`, 20, canvas.height - 35);
      ctx.fillText(`‚öîÔ∏è Dificultad: ${building.difficulty}/5`, 20, canvas.height - 20);
      ctx.fillText('Presiona ENTER para entrar', 20, canvas.height - 5);
    }
    
    // Indicador visual de Lloyd mejorado
    ctx.fillStyle = 'rgba(0, 255, 0, 0.3)';
    ctx.fillRect(player1.x - 50, player1.y - 50, 100, 100);
    
    ctx.fillStyle = '#00ff00';
    ctx.font = 'bold 18px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('LLOYD', player1.x, player1.y - 70);
    
    // Indicador de direcci√≥n
    ctx.fillStyle = '#00ff00';
    ctx.fillRect(player1.x - 3, player1.y - 3, 6, 6);
    
    // Bot√≥n de prueba temporal para movimiento
    ctx.fillStyle = 'rgba(0, 255, 0, 0.8)';
    ctx.fillRect(50, 50, 100, 30);
    ctx.fillStyle = 'black';
    ctx.font = '12px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('TEST MOVE', 100, 70);
    
    // Bot√≥n para forzar movimiento
    ctx.fillStyle = 'rgba(255, 0, 0, 0.8)';
    ctx.fillRect(50, 90, 100, 30);
    ctx.fillStyle = 'white';
    ctx.fillText('FORCE MOVE', 100, 110);
  }
  
  // Draw health numbers
  if (player1) {
    ctx.fillStyle = 'white';
    ctx.font = '14px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(`${player1.health}`, player1.x, player1.y - 50);
  }
  
  if (player2) {
    ctx.fillStyle = 'white';
    ctx.font = '14px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(`${player2.health}`, player2.x, player2.y - 50);
  }
  
  // Update UI
  updateUI();
}

function openShop() {
  console.log("openShop called");
  console.log("Menu element:", document.getElementById("menu"));
  console.log("Shop element:", document.getElementById("shop"));
  
  // Ocultar men√∫ principal
  document.getElementById("menu").style.display = "none";
  
  // Mostrar tienda
  document.getElementById("shop").style.display = "flex";
  gameState = "shop";
  
  console.log("Menu display:", document.getElementById("menu").style.display);
  console.log("Shop display:", document.getElementById("shop").style.display);
  
  // Actualizar informaci√≥n de la tienda
  updateShopInfo();
}

function updateShopInfo() {
  // Actualizar cash en la tienda
  document.getElementById("shopCash").textContent = playerCash;
  
  // Verificar si el personaje ya est√° desbloqueado
  const unlockedCharacters = JSON.parse(localStorage.getItem('unlockedCharacters') || '[]');
  const ninjaAzulButton = document.getElementById("buyNinjaAzul");
  const ninjaAzulImage = document.getElementById("ninjaAzulImage");
  
  if (unlockedCharacters.includes('ninjaAzul')) {
    ninjaAzulButton.textContent = "Ya Desbloqueado";
    ninjaAzulButton.disabled = true;
    // Mostrar imagen normal (sin fondo)
    ninjaAzulImage.src = "images/ChatGPT Image Sep 4, 2025, 03_29_16 PM-fotor-bg-remover-2025090415471.png";
    ninjaAzulImage.style.filter = "none";
  } else {
    ninjaAzulButton.textContent = "Comprar (1,000 Cash)";
    ninjaAzulButton.disabled = false;
    // Mostrar imagen en gris (con fondo)
    ninjaAzulImage.src = "images/ChatGPT Image Sep 4, 2025, 03_29_16 PM.png";
    ninjaAzulImage.style.filter = "grayscale(100%) brightness(0.5)";
  }
  
  // Mostrar habilidades activas del jugador
  showActiveSkills();
}

function showActiveSkills() {
  const activeSkills = JSON.parse(localStorage.getItem('activeSkills') || '[]');
  const skillsContainer = document.getElementById("activeSkills");
  
  if (skillsContainer) {
    if (activeSkills.length === 0) {
      skillsContainer.innerHTML = '<p style="color: #ccc; text-align: center;">No tienes habilidades activas</p>';
    } else {
      let skillsHTML = '<h4 style="color: #00ff00; text-align: center;">Habilidades Activas:</h4>';
      activeSkills.forEach(skillId => {
        skillsHTML += `<div style="color: #00ff00; margin: 5px 0;">‚ö° ${getSkillName(skillId)}</div>`;
      });
      skillsContainer.innerHTML = skillsHTML;
    }
  }
}

function buyCash(amount, priceUSD) {
  alert(`üí≥ Para comprar ${amount.toLocaleString()} cash por $${priceUSD} USD, contacta al administrador del juego.`);
}

function buyCharacter(characterId) {
  const character = characters[characterId];
  if (!character) {
    alert("‚ùå Personaje no encontrado.");
    return;
  }
  
  if (playerCash < character.price) {
    alert(`‚ùå No tienes suficiente cash. Necesitas ${character.price} cash, pero tienes ${playerCash}.`);
    return;
  }
  
  // Comprar personaje
  playerCash -= character.price;
  localStorage.setItem('playerCash', playerCash.toString());
  
  // Desbloquear personaje
  const unlockedCharacters = JSON.parse(localStorage.getItem('unlockedCharacters') || '[]');
  if (!unlockedCharacters.includes(characterId)) {
    unlockedCharacters.push(characterId);
    localStorage.setItem('unlockedCharacters', JSON.stringify(unlockedCharacters));
  }
  
  // Actualizar UI
  document.getElementById("menuCash").textContent = playerCash;
  
  // Si es la ninja azul, actualizar la imagen inmediatamente
  if (characterId === 'ninjaAzul') {
    const ninjaAzulImage = document.getElementById("ninjaAzulImage");
    if (ninjaAzulImage) {
      ninjaAzulImage.src = "images/ChatGPT Image Sep 4, 2025, 03_29_16 PM-fotor-bg-remover-2025090415471.png";
      ninjaAzulImage.style.filter = "none";
    }
  }
  
  updateShopInfo();
  
  alert(`üéâ ¬°Has desbloqueado a ${character.name}! Ahora puedes usarlo en batalla.`);
}

function backToMenuFromShop() {
  document.getElementById("shop").style.display = "none";
  document.getElementById("menu").style.display = "flex";
  gameState = "menu";
  
  // Actualizar cash en el men√∫ principal
  document.getElementById("menuCash").textContent = playerCash;
}

function updateCharacterSelectVisibility() {
  const unlockedCharacters = JSON.parse(localStorage.getItem('unlockedCharacters') || '[]');
  const ninjaAzulCard = document.getElementById("ninjaAzulCard");
  const ninjaAzulLocked = document.getElementById("ninjaAzulLocked");
  
  if (ninjaAzulCard && ninjaAzulLocked) {
    if (unlockedCharacters.includes('ninjaAzul')) {
      // Personaje desbloqueado - mostrar normal
      ninjaAzulCard.style.opacity = "1";
      ninjaAzulCard.style.pointerEvents = "auto";
      ninjaAzulLocked.style.display = "none";
    } else {
      // Personaje bloqueado - mostrar con overlay
      ninjaAzulCard.style.opacity = "0.6";
      ninjaAzulCard.style.pointerEvents = "auto"; // Permitir clic para mostrar mensaje
      ninjaAzulLocked.style.display = "flex";
    }
  }
}

function buySkillBox(boxType) {
  const prices = {
    'common': 500,
    'rare': 1500,
    'epic': 3000,
    'legendary': 7500
  };
  
  const price = prices[boxType];
  
  if (playerCash < price) {
    alert(`‚ùå No tienes suficiente cash. Necesitas ${price} cash, pero tienes ${playerCash}.`);
    return;
  }
  
  // Comprar caja
  playerCash -= price;
  localStorage.setItem('playerCash', playerCash.toString());
  
  // Generar habilidades aleatorias
  const skills = generateRandomSkills(boxType);
  
  // Actualizar UI
  document.getElementById("shopCash").textContent = playerCash;
  document.getElementById("menuCash").textContent = playerCash;
  
  // Mostrar habilidades obtenidas
  showObtainedSkills(skills, boxType);
}

function generateRandomSkills(boxType) {
  const skillPools = {
    'common': [
      { name: 'Ataque R√°pido', effect: 'attack', value: 5, description: '+5 Attack' },
      { name: 'Defensa B√°sica', effect: 'defense', value: 3, description: '+3 Defense' },
      { name: 'Velocidad Extra', effect: 'speed', value: 1, description: '+1 Speed' },
      { name: 'Vida Extra', effect: 'health', value: 20, description: '+20 Health' }
    ],
    'rare': [
      { name: 'Ataque Fuerte', effect: 'attack', value: 10, description: '+10 Attack' },
      { name: 'Defensa S√≥lida', effect: 'defense', value: 8, description: '+8 Defense' },
      { name: 'Velocidad Mejorada', effect: 'speed', value: 2, description: '+2 Speed' },
      { name: 'Vida Mejorada', effect: 'health', value: 40, description: '+40 Health' },
      { name: 'Da√±o Especial', effect: 'specialDamage', value: 15, description: '+15 Special Damage' }
    ],
    'epic': [
      { name: 'Ataque √âpico', effect: 'attack', value: 15, description: '+15 Attack' },
      { name: 'Defensa √âpica', effect: 'defense', value: 12, description: '+12 Defense' },
      { name: 'Velocidad √âpica', effect: 'speed', value: 3, description: '+3 Speed' },
      { name: 'Vida √âpica', effect: 'health', value: 60, description: '+60 Health' },
      { name: 'Da√±o Especial √âpico', effect: 'specialDamage', value: 25, description: '+25 Special Damage' },
      { name: 'Regeneraci√≥n', effect: 'regeneration', value: 5, description: '+5 HP per second' }
    ],
    'legendary': [
      { name: 'Ataque Legendario', effect: 'attack', value: 25, description: '+25 Attack' },
      { name: 'Defensa Legendaria', effect: 'defense', value: 20, description: '+20 Defense' },
      { name: 'Velocidad Legendaria', effect: 'speed', value: 5, description: '+5 Speed' },
      { name: 'Vida Legendaria', effect: 'health', value: 100, description: '+100 Health' },
      { name: 'Da√±o Especial Legendario', effect: 'specialDamage', value: 40, description: '+40 Special Damage' },
      { name: 'Inmortalidad', effect: 'immortality', value: 1, description: 'Cannot die below 1 HP' }
    ]
  };
  
  const pool = skillPools[boxType];
  const minSkills = boxType === 'common' ? 1 : boxType === 'rare' ? 2 : boxType === 'epic' ? 3 : 4;
  const maxSkills = boxType === 'common' ? 3 : boxType === 'rare' ? 4 : boxType === 'epic' ? 5 : 6;
  const numSkills = Math.floor(Math.random() * (maxSkills - minSkills + 1)) + minSkills;
  
  const selectedSkills = [];
  for (let i = 0; i < numSkills; i++) {
    const randomSkill = pool[Math.floor(Math.random() * pool.length)];
    selectedSkills.push({...randomSkill, id: Date.now() + i});
  }
  
  return selectedSkills;
}

function showObtainedSkills(skills, boxType) {
  let message = `üéÅ ¬°Has abierto una ${getBoxTypeName(boxType)}!\n\nHabilidades obtenidas:\n\n`;
  
  skills.forEach(skill => {
    message += `‚ú® ${skill.name}: ${skill.description}\n`;
  });
  
  message += `\nüí∞ Cash restante: ${playerCash}`;
  
  alert(message);
}

function getBoxTypeName(boxType) {
  const names = {
    'common': 'Caja Com√∫n',
    'rare': 'Caja Rara',
    'epic': 'Caja √âpica',
    'legendary': 'Caja Legendaria'
  };
  return names[boxType] || boxType;
}

function buySkill(skillId) {
  const skillPrices = {
    'fireBoost': 800,
    'iceBoost': 800,
    'lightningBoost': 800,
    'energyBoost': 800
  };
  
  const price = skillPrices[skillId];
  
  if (playerCash < price) {
    alert(`‚ùå No tienes suficiente cash. Necesitas ${price} cash, pero tienes ${playerCash}.`);
    return;
  }
  
  // Comprar habilidad
  playerCash -= price;
  localStorage.setItem('playerCash', playerCash.toString());
  
  // Aplicar habilidad
  applySkill(skillId);
  
  // Actualizar UI
  document.getElementById("shopCash").textContent = playerCash;
  document.getElementById("menuCash").textContent = playerCash;
  
  alert(`‚ö° ¬°Has comprado la habilidad ${getSkillName(skillId)}!`);
}

function getSkillName(skillId) {
  const names = {
    'fireBoost': 'Fuego Mejorado',
    'iceBoost': 'Hielo Mejorado',
    'lightningBoost': 'Rayo Mejorado',
    'energyBoost': 'Energ√≠a Mejorada'
  };
  return names[skillId] || skillId;
}

function applySkill(skillId) {
  // Obtener habilidades activas del jugador
  let activeSkills = JSON.parse(localStorage.getItem('activeSkills') || '[]');
  
  // Agregar nueva habilidad
  if (!activeSkills.includes(skillId)) {
    activeSkills.push(skillId);
    localStorage.setItem('activeSkills', JSON.stringify(activeSkills));
  }
}

function applyActiveSkills(player) {
  const activeSkills = JSON.parse(localStorage.getItem('activeSkills') || '[]');
  
  activeSkills.forEach(skillId => {
    switch (skillId) {
      case 'fireBoost':
        if (player.id === 'kai') {
          player.specialDamage = Math.floor(player.specialDamage * 1.25);
        }
        break;
      case 'iceBoost':
        if (player.id === 'zane') {
          player.specialDamage = Math.floor(player.specialDamage * 1.25);
        }
        break;
      case 'lightningBoost':
        if (player.id === 'jay') {
          player.specialDamage = Math.floor(player.specialDamage * 1.25);
        }
        break;
      case 'energyBoost':
        if (player.id === 'lloyd') {
          player.specialDamage = Math.floor(player.specialDamage * 1.25);
        }
        break;
    }
  });
}

// Funciones del modo aventura
function startAdventureMode() {
  // Ocultar men√∫ principal y selecci√≥n de mundos
  document.getElementById("menu").style.display = "none";
  document.getElementById("worldSelect").style.display = "none";
  
  // Configurar para modo aventura en Lego City
  isAdventureMode = true;
  selectedWorld = 'legoCity';
  selectedCharacter = 'lloyd'; // Lloyd (Ninja Verde) como personaje por defecto
  
  // Mostrar canvas y ocultar otros elementos
  canvas.style.display = "block";
  document.getElementById("adventureMode").style.display = "none";
  
  // Asegurar que el canvas tenga foco para recibir eventos de teclado
  // Asegurar que el canvas tenga el foco
  canvas.focus();
  canvas.tabIndex = 0;
  
  // Forzar el foco en el canvas
  setTimeout(() => {
    canvas.focus();
    console.log("Canvas focused for movement");
    console.log("Canvas tabIndex:", canvas.tabIndex);
    console.log("Canvas has focus:", document.activeElement === canvas);
  }, 100);
  
  // Agregar event listeners espec√≠ficos para el canvas
  canvas.addEventListener('keydown', (e) => {
    keys[e.key.toLowerCase()] = true;
    console.log("Canvas keydown:", e.key.toLowerCase());
    e.preventDefault();
  });
  
  canvas.addEventListener('keyup', (e) => {
    keys[e.key.toLowerCase()] = false;
    console.log("Canvas keyup:", e.key.toLowerCase());
    e.preventDefault();
  });
  
  // Inicializar jugador para modo aventura
  player1 = {
    id: 'lloyd',
    name: 'Lloyd (Green Ninja)',
    x: playerPosition.x,
    y: playerPosition.y,
    width: 80,
    height: 100, // M√°s alto
    speed: 12, // M√°s r√°pido para explorar la ciudad
    health: 100,
    maxHealth: 100,
    facing: 1,
    image: new Image(),
    isAI: false,
    lastAttack: 0,
    lastSpecial: 0,
    attackCooldown: 500,
    specialCooldown: 2000,
    isAttacking: false,
    isSpecialAttacking: false,
    animationFrame: 0
  };
  
  // Cargar imagen del personaje
  player1.image.src = characters[selectedCharacter].img;
  console.log("Adventure mode: Initialized player1:", player1);
  console.log("Adventure mode: Character image src:", characters[selectedCharacter].img);
  
  // Verificar cuando la imagen se carga
  player1.image.onload = function() {
    console.log("Adventure mode: Character image loaded successfully");
  };
  
  player1.image.onerror = function() {
    console.log("Adventure mode: Error loading character image");
  };
  
  // Inicializar edificios de la ciudad
  initializeCityBuildings();
  
  // Actualizar informaci√≥n del modo aventura
  updateAdventureInfo();
  
  // Cambiar estado del juego
  gameState = "battle"; // Usar el mismo estado para el renderizado
  
  // Iniciar loop del juego
  gameLoop();
  
  console.log("Adventure mode started - Lloyd should be able to move now!");
  
  // Mostrar mensaje de bienvenida
  setTimeout(() => {
    alert("üèôÔ∏è ¬°Bienvenido al Modo Aventura!\n\nü•∑ Eres Lloyd, el Ninja Verde\nüéÆ Usa WASD para explorar la ciudad\nüèÜ Encuentra torneos y edificios\nüí∞ Gana cash y experiencia\n\n¬°Explora toda la ciudad de Lego!");
  }, 500);
  
  console.log("Adventure mode initialized - movement should work now!");
}

function updateAdventureInfo() {
  // Actualizar cash, nivel y dificultad en el modo aventura
  if (document.getElementById("adventureCash")) {
    document.getElementById("adventureCash").textContent = playerCash;
  }
  if (document.getElementById("adventureLevel")) {
    document.getElementById("adventureLevel").textContent = playerLevel;
  }
  if (document.getElementById("adventureDifficulty")) {
    document.getElementById("adventureDifficulty").textContent = aiDifficulty;
  }
}

function checkNearbyTournaments() {
  if (!isAdventureMode || !worlds[selectedWorld] || !worlds[selectedWorld].tournaments) return;
  
  nearbyTournaments = [];
  const tournaments = worlds[selectedWorld].tournaments;
  
  tournaments.forEach(tournament => {
    const distance = Math.sqrt(
      Math.pow(player1.x - tournament.location.x, 2) + 
      Math.pow(player1.y - tournament.location.y, 2)
    );
    
    if (distance < 80) { // Radio de detecci√≥n
      nearbyTournaments.push(tournament);
    }
  });
}

function enterTournamentFromAdventure(tournament) {
  if (!tournament) return;
  
  const difficultyNames = {
    'easy': 'F√°cil',
    'medium': 'Intermedio', 
    'hard': 'Dif√≠cil',
    'extreme': 'Extremo'
  };
  
  const rewards = {
    'easy': 500,
    'medium': 1000,
    'hard': 2000,
    'extreme': 5000
  };
  
  const difficultyMultipliers = {
    'easy': 0.5,
    'medium': 1.0,
    'hard': 1.5,
    'extreme': 2.0
  };
  
  // Confirmar entrada al torneo
  if (confirm(`üèÜ ${tournament.name}\n\n${tournament.description}\n\nRecompensa: üí∞ ${tournament.reward} cash\nDificultad: ${difficultyNames[tournament.difficulty]}\n\n¬øQuieres participar?`)) {
    // Salir del modo aventura
    isAdventureMode = false;
    
    // Configurar torneo
    currentTournament = tournament;
    
    // Iniciar batalla del torneo
    startTournamentBattle(tournament, difficultyMultipliers[tournament.difficulty], tournament.reward);
  }
}

function startTournamentBattle(tournament, difficultyMultiplier, reward) {
  // Configurar oponente para el torneo
  const opponentCharacters = ['kai', 'zane', 'lloyd', 'cole', 'jay', 'nya'];
  const randomOpponent = opponentCharacters[Math.floor(Math.random() * opponentCharacters.length)];
  
  player2 = {
    id: 'opponent',
    name: `Oponente del ${tournament.name}`,
    x: canvas.width - 150,
    y: canvas.height / 2,
    width: 64,
    height: 64,
    speed: 3 * difficultyMultiplier,
    health: 100 * difficultyMultiplier,
    maxHealth: 100 * difficultyMultiplier,
    facing: -1,
    target: player1,
    image: new Image(),
    lastAttack: 0,
    attackCooldown: 1000 / difficultyMultiplier,
    lastSpecial: 0,
    specialCooldown: 3000 / difficultyMultiplier
  };
  
  player2.image.src = characters[randomOpponent].img;
  
  // Ajustar dificultad de la IA
  aiDifficulty = Math.min(10, Math.floor(difficultyMultiplier * 5));
  
  // Iniciar batalla
  gameState = "battle";
  updateUI();
}

function exitAdventureMode() {
  isAdventureMode = false;
  player1 = null;
  player2 = null;
  canvas.style.display = "none";
  document.getElementById("worldSelect").style.display = "flex";
  gameState = "worldSelect";
}

// Funciones del modo online
function startOnlineMode() {
  // Ocultar men√∫ principal
  document.getElementById("menu").style.display = "none";
  
  // Mostrar modo online
  document.getElementById("onlineMode").style.display = "flex";
  
  // Actualizar cash en el modo online
  if (document.getElementById("onlineCash")) {
    document.getElementById("onlineCash").textContent = playerCash;
  }
  
  // Inicializar conexi√≥n WebSocket (simulada para demo)
  initializeOnlineMode();
}

function initializeOnlineMode() {
  // Simular conexi√≥n online (en un juego real usar√≠as Socket.IO)
  console.log("Inicializando modo online...");
  
  // Cargar personajes disponibles para online
  loadOnlineCharacters();
  
  // Configurar chat
  setupOnlineChat();
  
  addChatMessage("Sistema", "Modo online inicializado. ¬°Crea o √∫nete a una sala!", "system");
}

function loadOnlineCharacters() {
  const container = document.getElementById("onlineCharacterSelect");
  container.innerHTML = "";
  
  const onlineCharacters = [
    { id: 'kai', name: 'Kai', img: 'images/ninjarojosinmascara.png.png' },
    { id: 'zane', name: 'Zane', img: 'images/ninjablanco.png-fotor-bg-remover-20250902204741.png' },
    { id: 'jay', name: 'Jay', img: 'images/ninjaazul.png-fotor-bg-remover-20250902204441.png' },
    { id: 'cole', name: 'Cole', img: 'images/ninjaazul.png-fotor-bg-remover-20250902204441.png' }
  ];
  
  onlineCharacters.forEach(character => {
    const card = document.createElement('div');
    card.className = 'onlineCharacterCard';
    card.innerHTML = `
      <img src="${character.img}" alt="${character.name}">
      <div>${character.name}</div>
    `;
    
    card.addEventListener('click', () => {
      selectOnlineCharacter(character.id);
    });
    
    container.appendChild(card);
  });
}

function selectOnlineCharacter(characterId) {
  selectedOnlineCharacter = characterId;
  
  // Actualizar selecci√≥n visual
  document.querySelectorAll('.onlineCharacterCard').forEach(card => {
    card.classList.remove('selected');
  });
  
  event.target.closest('.onlineCharacterCard').classList.add('selected');
  
  addChatMessage("Sistema", `Seleccionaste ${characterId}`, "system");
}

function createRoom() {
  const roomId = generateRoomId();
  document.getElementById('roomIdInput').value = roomId;
  joinRoom();
}

function joinRoom() {
  const roomId = document.getElementById('roomIdInput').value.trim().toUpperCase();
  if (!roomId) {
    alert('Please enter a room ID');
    return;
  }
  
  currentRoom = roomId;
  document.getElementById('roomStatus').style.display = 'block';
  document.getElementById('roomStatus').textContent = `Room: ${roomId} - Waiting for players...`;
  
  addChatMessage("Sistema", `Joined room ${roomId}`, "system");
  
  // Simular que otro jugador se une
  setTimeout(() => {
    if (currentRoom === roomId) {
      document.getElementById('roomStatus').textContent = `Room: ${roomId} - Ready to start!`;
      document.getElementById('startOnlineGameBtn').disabled = false;
      addChatMessage("Sistema", "Another player joined! Ready to start!", "system");
    }
  }, 2000);
}

function generateRoomId() {
  return Math.random().toString(36).substr(2, 6).toUpperCase();
}

function startOnlineGame() {
  if (!selectedOnlineCharacter) {
    alert('Please select a character first');
    return;
  }
  
  addChatMessage("Sistema", "Starting online battle!", "system");
  
  // Simular inicio de juego online
  setTimeout(() => {
    startOnlineBattle();
  }, 1000);
}

function startOnlineBattle() {
  // Ocultar modo online
  document.getElementById("onlineMode").style.display = "none";
  
  // Configurar para batalla online
  isOnlineMode = true;
  selectedWorld = 'ice'; // Mundo por defecto para online
  selectedCharacter = selectedOnlineCharacter;
  
  // Mostrar canvas
  canvas.style.display = "block";
  
  // Inicializar jugadores
  player1 = {
    id: 'player1',
    name: 'You',
    x: 200,
    y: 300,
    width: 80,
    height: 100,
    speed: 8,
    health: 100,
    maxHealth: 100,
    facing: 1,
    image: new Image()
  };
  
  // Simular oponente online
  player2 = {
    id: 'player2',
    name: 'Online Player',
    x: 600,
    y: 300,
    width: 80,
    height: 100,
    speed: 8,
    health: 100,
    maxHealth: 100,
    facing: -1,
    image: new Image()
  };
  
  // Cargar im√°genes
  player1.image.src = characters[selectedCharacter].img;
  player2.image.src = characters['kai'].img; // Oponente fijo
  
  // Cambiar estado del juego
  gameState = "battle";
  
  // Iniciar loop del juego
  gameLoop();
}

function setupOnlineChat() {
  const chatInput = document.getElementById('chatInput');
  chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      sendOnlineMessage();
    }
  });
}

function sendOnlineMessage() {
  const input = document.getElementById('chatInput');
  const message = input.value.trim();
  if (message) {
    addChatMessage("You", message, "player");
    input.value = '';
    
    // Simular respuesta del otro jugador
    setTimeout(() => {
      if (currentRoom) {
        addChatMessage("Online Player", "Nice move!", "player");
      }
    }, 1000);
  }
}

function addChatMessage(player, message, type) {
  const container = document.getElementById('chatMessages');
  const messageEl = document.createElement('div');
  messageEl.className = `chat-message ${type}`;
  messageEl.textContent = `${player}: ${message}`;
  container.appendChild(messageEl);
  container.scrollTop = container.scrollHeight;
}

function backToMenuFromOnline() {
  isOnlineMode = false;
  currentRoom = null;
  selectedOnlineCharacter = null;
  document.getElementById("onlineMode").style.display = "none";
  document.getElementById("menu").style.display = "flex";
}

// Funci√≥n para dibujar edificios de la ciudad
function drawCityBuildings() {
  const buildings = [
    { x: 150, y: 200, width: 120, height: 150, name: "üè¢ City Hall", type: "government" },
    { x: 400, y: 180, width: 100, height: 120, name: "üè™ Shop", type: "shop" },
    { x: 650, y: 220, width: 110, height: 140, name: "üè• Hospital", type: "hospital" },
    { x: 200, y: 450, width: 90, height: 110, name: "üè´ School", type: "school" },
    { x: 500, y: 480, width: 130, height: 160, name: "üè≠ Factory", type: "factory" },
    { x: 800, y: 400, width: 100, height: 130, name: "üè® Hotel", type: "hotel" },
    { x: 100, y: 350, width: 80, height: 100, name: "üè† House", type: "house" },
    { x: 700, y: 300, width: 90, height: 120, name: "üè™ Market", type: "market" }
  ];
  
  buildings.forEach(building => {
    // Dibujar edificio
    ctx.fillStyle = getBuildingColor(building.type);
    ctx.fillRect(building.x, building.y, building.width, building.height);
    
    // Dibujar borde
    ctx.strokeStyle = '#333';
    ctx.lineWidth = 2;
    ctx.strokeRect(building.x, building.y, building.width, building.height);
    
    // Dibujar ventanas
    drawBuildingWindows(building);
    
    // Dibujar nombre del edificio
    ctx.fillStyle = 'white';
    ctx.font = 'bold 12px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(building.name, building.x + building.width/2, building.y - 10);
    
    // Verificar si el jugador est√° cerca del edificio
    if (player1 && isPlayerNearBuilding(player1, building)) {
      // Dibujar indicador de interacci√≥n
      ctx.fillStyle = 'rgba(0, 255, 0, 0.7)';
      ctx.fillRect(building.x - 5, building.y - 5, building.width + 10, building.height + 10);
      
      // Mostrar prompt de interacci√≥n
      ctx.fillStyle = 'white';
      ctx.font = 'bold 14px Arial';
      ctx.fillText('Press ENTER to enter', building.x + building.width/2, building.y - 25);
    }
  });
}

function getBuildingColor(type) {
  const colors = {
    'government': '#4A90E2',
    'shop': '#F5A623',
    'hospital': '#D0021B',
    'school': '#7ED321',
    'factory': '#9013FE',
    'hotel': '#50E3C2',
    'house': '#B8E986',
    'market': '#F8E71C'
  };
  return colors[type] || '#666';
}

function drawBuildingWindows(building) {
  ctx.fillStyle = '#FFD700';
  const windowSize = 15;
  const spacing = 25;
  
  for (let x = building.x + spacing; x < building.x + building.width - spacing; x += spacing) {
    for (let y = building.y + spacing; y < building.y + building.height - spacing; y += spacing) {
      ctx.fillRect(x, y, windowSize, windowSize);
    }
  }
}

function isPlayerNearBuilding(player, building) {
  const distance = Math.sqrt(
    Math.pow(player.x - (building.x + building.width/2), 2) + 
    Math.pow(player.y - (building.y + building.height/2), 2)
  );
  return distance < 100; // Radio de interacci√≥n
}

// Variables para edificios cercanos (ya declarado arriba)

function checkNearbyBuildings() {
  if (!isAdventureMode || !player1) return;
  
  nearbyBuildings = [];
  const buildings = [
    { x: 150, y: 200, width: 120, height: 150, name: "üè¢ City Hall", type: "government" },
    { x: 400, y: 180, width: 100, height: 120, name: "üè™ Shop", type: "shop" },
    { x: 650, y: 220, width: 110, height: 140, name: "üè• Hospital", type: "hospital" },
    { x: 200, y: 450, width: 90, height: 110, name: "üè´ School", type: "school" },
    { x: 500, y: 480, width: 130, height: 160, name: "üè≠ Factory", type: "factory" },
    { x: 800, y: 400, width: 100, height: 130, name: "üè® Hotel", type: "hotel" },
    { x: 100, y: 350, width: 80, height: 100, name: "üè† House", type: "house" },
    { x: 700, y: 300, width: 90, height: 120, name: "üè™ Market", type: "market" }
  ];
  
  buildings.forEach(building => {
    if (isPlayerNearBuilding(player1, building)) {
      nearbyBuildings.push(building);
    }
  });
}

function enterBuilding(building) {
  if (!building) return;
  
  // Diferentes acciones seg√∫n el tipo de edificio
  switch(building.type) {
    case 'shop':
      alert(`üè™ Welcome to the Shop!\n\nYou can buy items here with your cash.\nCurrent cash: $${playerCash}`);
      break;
    case 'hospital':
      alert(`üè• Welcome to the Hospital!\n\nYour health has been restored to full!\nHealth: 100/100`);
      if (player1) player1.health = player1.maxHealth;
      break;
    case 'school':
      alert(`üè´ Welcome to the School!\n\nYou learned new techniques!\nYour level increased by 1!`);
      playerLevel += 1;
      break;
    case 'government':
      alert(`üè¢ Welcome to City Hall!\n\nYou received a government bonus!\nCash: +500`);
      playerCash += 500;
      break;
    case 'factory':
      alert(`üè≠ Welcome to the Factory!\n\nYou worked a shift and earned money!\nCash: +200`);
      playerCash += 200;
      break;
    case 'hotel':
      alert(`üè® Welcome to the Hotel!\n\nYou rested and recovered energy!\nAll cooldowns reset!`);
      if (player1) {
        player1.lastAttack = 0;
        player1.lastSpecial = 0;
      }
      break;
    case 'house':
      alert(`üè† Welcome to the House!\n\nYou found a secret stash!\nCash: +100`);
      playerCash += 100;
      break;
    case 'market':
      alert(`üè™ Welcome to the Market!\n\nYou bought some supplies!\nCash: -50, Health: +20`);
      playerCash -= 50;
      if (player1) player1.health = Math.min(player1.maxHealth, player1.health + 20);
      break;
    default:
      alert(`Welcome to ${building.name}!`);
  }
}

function enterTournament(district, difficulty) {
  const difficultyNames = {
    'easy': 'F√°cil',
    'medium': 'Intermedio',
    'hard': 'Dif√≠cil'
  };
  
  const rewards = {
    'easy': 150,
    'medium': 300,
    'hard': 500
  };
  
  const difficultyMultipliers = {
    'easy': 0.5,
    'medium': 1.0,
    'hard': 1.5
  };
  
  // Confirmar entrada al torneo
  if (confirm(`üèÜ ¬øQuieres entrar al Torneo ${difficultyNames[difficulty]} en el Distrito ${district}?\n\nRecompensa: üí∞ ${rewards[difficulty]} cash\nDificultad: ${difficultyNames[difficulty]}`)) {
    // Ocultar modo aventura
    document.getElementById("adventureMode").style.display = "none";
    
    // Iniciar torneo
    startTournament(district, difficulty, difficultyMultipliers[difficulty], rewards[difficulty]);
  }
}

function startTournament(district, difficulty, difficultyMultiplier, reward) {
  // Configurar torneo
  gameState = "tournament";
  currentTournament = {
    district: district,
    difficulty: difficulty,
    difficultyMultiplier: difficultyMultiplier,
    reward: reward,
    currentRound: 1,
    totalRounds: 3,
    opponents: generateTournamentOpponents(difficulty, difficultyMultiplier)
  };
  
  // Mostrar informaci√≥n del torneo
  showTournamentInfo();
}

function generateTournamentOpponents(difficulty, difficultyMultiplier) {
  const opponents = [];
  const characterIds = Object.keys(characters);
  
  for (let i = 0; i < 3; i++) {
    const randomCharacterId = characterIds[Math.floor(Math.random() * characterIds.length)];
    const baseCharacter = characters[randomCharacterId];
    
    // Crear oponente con stats modificados seg√∫n dificultad
    const opponent = {
      id: `tournament_${i}`,
      name: `${baseCharacter.name} (Torneo)`,
      img: baseCharacter.img,
      attack: Math.floor(baseCharacter.attack * difficultyMultiplier),
      defense: Math.floor(baseCharacter.defense * difficultyMultiplier),
      special: baseCharacter.special,
      specialDamage: Math.floor(baseCharacter.specialDamage * difficultyMultiplier),
      speed: Math.floor(baseCharacter.speed * difficultyMultiplier),
      weapon: baseCharacter.weapon,
      maxHealth: Math.floor(baseCharacter.maxHealth * difficultyMultiplier),
      health: Math.floor(baseCharacter.maxHealth * difficultyMultiplier),
      isTournamentOpponent: true
    };
    
    opponents.push(opponent);
  }
  
  return opponents;
}

function showTournamentInfo() {
  const tournament = currentTournament;
  
  // Crear interfaz del torneo
  const tournamentHTML = `
    <div id="tournamentUI" class="tournamentUI">
      <h2>üèÜ Torneo ${tournament.difficulty.toUpperCase()} - Ronda ${tournament.currentRound}/3</h2>
      <div class="tournamentProgress">
        <div class="progressBar">
          <div class="progressFill" style="width: ${(tournament.currentRound - 1) / 3 * 100}%"></div>
        </div>
      </div>
      <div class="opponentInfo">
        <h3>Pr√≥ximo Oponente:</h3>
        <div class="opponentCard">
          <h4>${tournament.opponents[tournament.currentRound - 1].name}</h4>
          <p>Attack: ${tournament.opponents[tournament.currentRound - 1].attack}</p>
          <p>Defense: ${tournament.opponents[tournament.currentRound - 1].defense}</p>
          <p>Health: ${tournament.opponents[tournament.currentRound - 1].maxHealth}</p>
        </div>
      </div>
      <button onclick="startTournamentBattle()" class="startBattleBtn">‚öîÔ∏è Iniciar Batalla</button>
      <button onclick="exitTournament()" class="exitBtn">‚ùå Salir del Torneo</button>
    </div>
  `;
  
  // Agregar al DOM
  document.body.insertAdjacentHTML('beforeend', tournamentHTML);
}

function startTournamentBattle() {
  // Ocultar interfaz del torneo
  const tournamentUI = document.getElementById("tournamentUI");
  if (tournamentUI) {
    tournamentUI.remove();
  }
  
  // Iniciar batalla del torneo
  const tournament = currentTournament;
  const opponent = tournament.opponents[tournament.currentRound - 1];
  
  // Configurar batalla
  selectedWorld = 'central'; // Mundo por defecto para torneos
  selectedCharacter = 'kai'; // Personaje por defecto (se puede cambiar)
  
  // Iniciar batalla
  startBattle();
  
  // Configurar oponente del torneo
  player2 = opponent;
  player2.x = canvas.width - 150;
  player2.y = canvas.height - 200;
  player2.target = player1;
  player2.state = 'chase';
  player2.facing = -1;
  player2.lastAttack = 0;
  player2.lastSpecial = 0;
  
  // Cargar imagen del oponente
  player2.image = new Image();
  player2.image.src = opponent.img;
  
  // Modificar funci√≥n de fin de batalla para torneos
  originalEndBattleWithWinner = endBattleWithWinner;
  endBattleWithWinner = endTournamentBattle;
}

function endTournamentBattle(winnerName) {
  const tournament = currentTournament;
  
  if (winnerName === player1.name) {
    // Jugador gan√≥ la ronda
    tournament.currentRound++;
    
    if (tournament.currentRound > tournament.totalRounds) {
      // Torneo completado
      const totalReward = tournament.reward * 3; // Recompensa por completar todo el torneo
      playerCash += totalReward;
      localStorage.setItem('playerCash', playerCash.toString());
      
      alert(`üèÜ ¬°Has completado el Torneo ${tournament.difficulty.toUpperCase()}!\n\nüí∞ Recompensa total: ${totalReward} cash\nüéØ ¬°Eres un verdadero maestro ninja!`);
      
      // Volver al modo aventura
      exitTournament();
    } else {
      // Siguiente ronda
      alert(`üèÜ ¬°Has ganado la Ronda ${tournament.currentRound - 1}!\n\n‚öîÔ∏è Pr√≥ximo oponente: ${tournament.opponents[tournament.currentRound - 1].name}\nüí∞ Recompensa acumulada: ${tournament.reward * tournament.currentRound}`);
      
      // Mostrar informaci√≥n de la siguiente ronda
      showTournamentInfo();
    }
  } else {
    // Jugador perdi√≥
    alert(`üíÄ Has perdido contra ${winnerName} en la Ronda ${tournament.currentRound}.\n\n‚ùå El torneo ha terminado. Vuelve a intentarlo cuando est√©s listo.`);
    
    // Volver al modo aventura
    exitTournament();
  }
  
  // Restaurar funci√≥n original
  endBattleWithWinner = originalEndBattleWithWinner;
  
  // Terminar batalla
  endBattle();
}

function exitTournament() {
  // Limpiar torneo actual
  currentTournament = null;
  
  // Volver al modo aventura
  document.getElementById("adventureMode").style.display = "flex";
  gameState = "adventure";
  
  // Actualizar informaci√≥n
  updateAdventureInfo();
}

function backToMenuFromAdventure() {
  document.getElementById("adventureMode").style.display = "none";
  document.getElementById("menu").style.display = "flex";
  gameState = "menu";
  
  // Actualizar informaci√≥n en el men√∫ principal
  if (document.getElementById("menuCash")) {
    document.getElementById("menuCash").textContent = playerCash;
  }
}

// Handle window resize
window.addEventListener('resize', () => {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  // Update mobile controls visibility on resize
  toggleMobileControls();
});

// Inicializar cash del jugador al cargar la p√°gina
window.addEventListener('load', () => {
  // Initialize mobile controls
  toggleMobileControls();
  
  if (localStorage.getItem('playerCash')) {
    playerCash = parseInt(localStorage.getItem('playerCash'));
  }
  if (document.getElementById("menuCash")) {
    document.getElementById("menuCash").textContent = playerCash;
  }
  
  // Setup payment form event listeners
  setupPaymentFormListeners();
  
  // Preload character sprites for animations
  preloadCharacterSprites();
});

// Setup payment form event listeners
function setupPaymentFormListeners() {
  // Card number formatting
  const cardNumberInput = document.getElementById('cardNumber');
  if (cardNumberInput) {
    cardNumberInput.addEventListener('input', function() {
      formatCardNumber(this);
    });
  }
  
  // Expiry date formatting
  const expiryDateInput = document.getElementById('expiryDate');
  if (expiryDateInput) {
    expiryDateInput.addEventListener('input', function() {
      formatExpiryDate(this);
    });
  }
  
  // CVV formatting (numbers only)
  const cvvInput = document.getElementById('cvv');
  if (cvvInput) {
    cvvInput.addEventListener('input', function() {
      this.value = this.value.replace(/\D/g, '');
    });
  }
  
  // Card name formatting (letters and spaces only)
  const cardNameInput = document.getElementById('cardName');
  if (cardNameInput) {
    cardNameInput.addEventListener('input', function() {
      this.value = this.value.replace(/[^a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s]/g, '');
    });
  }
  
  // Form submission
  const paymentForm = document.getElementById('paymentForm');
  if (paymentForm) {
    paymentForm.addEventListener('submit', processPayment);
  }
  
  // Close modal when clicking outside
  const paymentModal = document.getElementById('paymentModal');
  if (paymentModal) {
    paymentModal.addEventListener('click', function(event) {
      if (event.target === paymentModal) {
        closePaymentModal();
      }
    });
  }
}
</script>
</body>
</html>
